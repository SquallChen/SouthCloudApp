<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title></title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="../../css/mui.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="../../css/custom.css">
	<link rel="stylesheet" href="../../css/iconfont.css">
	<style>
		* {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
		}

		html,
		body,
		#vm {
			height: 100%;
		}

		a {
			color: #000;
		}

		.filter {
			width: 100%;
		}

		.filter a {
			display: block;
			width: 80%;
			height: 50px;
			line-height: 50px;
			font-size: 13px;
			padding-left: 20px;
		}

		.filter {
			height: 125px;
			margin-bottom: 20px;
			padding-top: 28px;
			padding-left: 25px;
			background: url('../../public/img/me_bg.png') no-repeat;
			background-size: 100% 125px;
		}

		.filter ul li {
			display: flex;
			align-items: center;
			position: relative;
			flex-wrap: wrap;
		}

		.filter ul li img {
			width: 55px;
			height: 55px;
			border-radius: 50px;
			border: 1px solid #fff;
		}

		.filter ul li span {
			color: white;
			font-size: 15px;
			display: block;
			line-height: 20px;
		}

		.filter ul li div {
			padding-left: 10px;
			font-size: 14px;
			margin-right: 15px;
		}

		.filter .userentry {
			border-bottom: 1px solid #ccc;
		}

		.filter .border_bottom {
			display: block;
			width: 100%;
			height: 1px;
			background: #ccc;
			left: 30px;
			bottom: 0px;
		}

		.mui-bar .mui-icon {
			font-size: 32px;
		}

		.mui-content {
			background: white;
			display: flex;
			flex-direction: column;
		}

		.usertitle {
			width: 100%;
			background: #f2f2f2;
			height: 30px;
		}

		.personnelInfo {
			width: 100%;
			overflow: hidden;
			flex: 1;
		}

		.personnelInfo ul li {
			height: 40px;
			font-size: 15px;
			line-height: 40px;
			color: #333;
		}

		.personnelInfo .mui-table-cell {
			display: flex;
		}

		.personnelInfo .img-content {
			width: 25%;
			display: flex;
			align-items: center;
			height: 60px;
		}

		.personnelInfo .main-content {
			width: 75%;
			padding-top: 12px;
		}

		.personnelInfo .main-content :nth-child(2) {
			position: relative;
			top: -4px;
		}

		.main-content .name,
		.mui-content .group {
			font-size: 13px;
		}

		.personnelInfo .main-content .group {
			top: 4px;
		}

		.main-content .pinyin {
			font-size: 11px;
		}

		.personnelInfo img {
			width: 36px;
			height: 36px;
			border-radius: 5px;
			position: relative;
			border: 1px solid #0b60de;
		}

		.personnelInfo .main-content div {
			display: flex;
			justify-content: space-between;
		}

		.personnelInfo .status {
			position: relative;
			top: -3px;
			background: linear-gradient(to bottom, #aeaeae, #707070);
			width: 16px;
			height: 16px;
			border-radius: 50px;
			border: 1px solid white;
			box-shadow: 0px 2px 4px 1px rgba(0, 0, 0, .25);
		}

		.personnelInfo .main-content .active {
			background: linear-gradient(to bottom, #39e131, #31bd2a);
			top: -2px;
		}

		.personnelInfo .mui-slider-right a:nth-child(1) {
			background: #00cc66;
		}

		.personnelInfo .mui-slider-right a:nth-child(2) {
			background: #ff9966;
		}

		.personnelInfo .mui-slider-right a:nth-child(3) {
			background: #0099ff;
		}

		.personnelInfo .mui-table-view-cell {
			padding: 0 10px;
		}

		.mui-table-view-cell:after {
			left: 0;
			background-color: #ccc;
		}

		#topPopover .mui-table-view-cell a {
			display: flex;
			align-items: center;
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
		}

		#topPopover .mui-table-view-cell a img {
			margin-right: 20px;
		}

		#topPopover .mui-table-view-cell {
			border-bottom: 1px solid #e3e3e3;
			height: 52px;
			line-height: 26px;
		}

		.mui-popover {
			height: 300px;
		}

		.mui-popover {
			width: 122px;
			height: 104px;
			box-shadow: 0 0 15px rgba(0, 0, 0, .3);
			background: white;
		}

		.mui-backdrop {
			background: transparent;
		}

		.mui-popover .mui-scroll-wrapper {
			margin: 0;
		}

		.mui-popover .mui-table-view .mui-table-view-cell:last-child,
		.mui-popover .mui-table-view .mui-table-view-cell:last-child,
		.mui-popover .mui-table-view .mui-table-view-cell:last-child>a:not(.mui-btn),
		.mui-popover .mui-table-view .mui-table-view-cell:first-child>a:not(.mui-btn) {
			border-bottom-left-radius: 0;
			border-bottom-right-radius: 0;
			border-top-left-radius: 0;
			border-top-right-radius: 0;
		}

		.userEntryImg {
			display: inline-block;
			width: 22px;
			height: 22px;
			background: url(../../public/img/user_icon01.png) no-repeat;
			background-size: 19px 22px;
			margin-left: 5px;
		}

		.userfilter {
			display: inline-block;
			width: 22px;
			height: 22px;
			background: url(../../public/img/user_icon02.png) no-repeat;
			background-size: 19px 22px;
			margin-left: 5px;
		}

		.mui-content .mui-icon {
			color: #ccc;
			position: relative;
			left: 15px;
		}

		.mui-content .mui-icon {
			color: #ccc;
			position: absolute;
			right: 15px;
			top: 13px;
		}

		.mui-popover .mui-table-view {
			background: white;
		}

		.mui-popover .mui-table-view {
			border-radius: 7px;
		}

		.mui-popover .mui-popover-arrow:after {
			background: white;
		}

		.mui-bar-nav {
			box-shadow: none;
		}

		.mui-bar-nav~.mui-content {
			padding-top: 73px;
		}

		#topPopover .mui-table-view-cell a span {
			display: inline-block;
			width: 68px;
			text-align: center;
			font-size: 15px;
			color: #666;
		}

		.btn a {
			width: 100%;
			font-size: 15px;
			display: block;
			padding: 9px 0 9px 10px;
			position: relative;
			color: #333;
			background: #f2f2f2;
			line-height: 20px;
		}

		.btn:after {
			width: 100%;
			height: 1px;
			content: '';
			display: block;
			padding: 0;
			position: relative;
			-webkit-transform: scaleY(.5);
			transform: scaleY(.5);
			background-color: #ccc;
			z-index: 1;
		}

		.btn:before {
			width: 100%;
			height: 1px;
			content: '';
			display: block;
			padding: 0;
			position: relative;
			-webkit-transform: scaleY(.5);
			transform: scaleY(.5);
			background-color: #ccc;
			z-index: 1;
		}

		.btn a span {
			font-size: 13px;
			color: #999;
			position: absolute;
			right: 15px;
			line-height: 20px;
		}

		.mui-table-view-cell {
			padding: 11px 15px;
		}

		.icon-related,
		.icon-sign-out {
			color: #666;
			width: 15px !important;
			height: 22px !important;
			font-size: 20px !important;
			margin-right: 10px;
		}

		.mui-table-view-cell:after {
			height: 0;
		}

		[v-cloak] {
			display: none;
		}
	</style>
</head>

<body>
	<div id="app" v-cloak>
		<header class="mui-bar mui-bar-nav">
			<a id="menu" class="mui-action-menu mui-icon mui-icon-plusempty mui-pull-right lists" href="#topPopover"></a>
			<h1 class="mui-title">南方云</h1>
		</header>
		<div class="mui-content">
			<div class="filter">
				<ul class="filter-ul">
					<li href="../personnel/userinfo.html" class="filter-li">
						<img src="../../public/img/01.jpg" alt="" class="img" />
						<div>
							<span>{{realName}}</span>
							<span>{{user_name}}</span>
						</div>
						<div>
							<span>{{workGroup}}</span>
						</div>
					</li>
				</ul>
			</div>
			<div class="btn">
				<a v-on:tap="linkDevice">关联设备
					<span>点击检测关联设备</span>
				</a>

			</div>
			<div class="personnelInfo">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">{{identifyCode}}
					</li>
				</ul>
			</div>
		</div>

		<!--右上角弹出菜单-->
		<div id="topPopover" class="mui-popover">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							<a href="#" v-on:tap="test">
								<span class="icon-related"></span>
								<span>设备关联</span>
							</a>
						</li>
						<li id="logout" class="mui-table-view-cell">
							<a href="#">
								<span class="icon-sign-out"></span>
								<span>退出登录</span>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/sha1.js"></script>
	<script src="../../js/url.js"></script>
	<script src="../../js/vue.min.js"></script>
	<script type="text/javascript">
		var vm = new Vue({
		  el: '#app',
		  data: {
		    token: '',
		    user_name: '',
		    rtkCount: '',
		    onlineRtkCount: '',
		    mapRtk: '',
		    workGroup: '',
		    realName: '',
		    signature: '',
		    userId: '',
		    identifyCode: ''
		  },
		  methods: {
		    openpage: function () {
		      var data_url = event.target.dataset.href;
		      mui.openWindow({
		        url: data_url,
		        id: data_url
		      });
		    },
		    test: function () {
		      mui.toast('此处调用关联接口....');
		      mui('#topPopover').popover('hide');
		    },
		    linkDevice: function () {
		      var websocket = new WebSocket('ws://127.0.0.1:9527/id');
		      websocket.onmessage = function (event) {
		        vm.identifyCode = event.data;
		        if (event.data) {
		          mui.ajax(apiUrl.setting_relation, {
		            data: {
		              user_name: vm.user_name,
		              token: vm.token,
		              identifyCode: vm.identifyCode
		            },
		            dataType: 'json',
		            type: 'post',
		            timeout: 10000,
		            success: function (data) {
		              if (data.status === 0) {
		                mui.toast('设备关联成功!');
		                plus.storage.setItem('linkCode', vm.identifyCode);
		              } else {
		                mui.toast('设备关联失败!');
		              }
		            },
		            error: function (xhr, type, errorThrown) {
		              onNetChange();
		            }
		          });
		        } else {
		          mui.toast('请使用工程之星蓝牙功能关联设备!');
		        }
		      };
		      websocket.onopen = function (event) {
		        console.log('ok');
		      };
		      websocket.onerror = function (event) {
		        mui.toast('关联设备失败,请先打开工程之星!');
		        document.addEventListener('plusready', function () {
		          plus.storage.removeItem('linkCode');
		        }, false);
		      };
		      websocket.onclose = function (event) {
		        console.log('close');
		      };
		    }
		  },
		  created: function () {
		    mui.plusReady(function () {
		      mui.init({});
		      // 登陆时存放到本地的数据
		      vm.token = plus.storage.getItem('token');
		      vm.user_name = plus.storage.getItem('user_name');
		      vm.realName = plus.storage.getItem('realName');
		      vm.workGroup = plus.storage.getItem('workGroup') !== 'undefined' ? plus.storage.getItem('workGroup') : '暂无分组';
		      vm.password = plus.storage.getItem('passWord');
		      vm.signature = plus.storage.getItem('signature');
		      vm.user_name = plus.storage.getItem('user_name');
		      // 页面顶部筛选按钮跳转
		      mui('.filter-ul').on('tap', '.filter-li', function (e) {
		        var url = this.getAttribute('href');
		        mui.openWindow({
		          url: url,
		          id: url,
		          extras: {
		            currentAccount: 'parentAccount'
		          }
		        });
		      });

		      document.getElementById('logout').addEventListener('tap', function () {
		        mui('#logout').button('loading');
		        var lauchFlag = plus.storage.getItem('lauchFlag');
		        plus.storage.clear();
		        plus.storage.setItem('lauchFlag', lauchFlag);

		        mui('#logout').button('reset');

		        mui.ajax(apiUrl.logout, {
		          data: {
		            user_name: vm.user_name,
		            token: vm.token
		          },
		          dataType: 'json',
		          type: 'post',
		          timeout: 10000,
		          success: function (data) {
		            if (data.status === 0 || data.status === 40004) {
		              mui.openWindow({
		                url: '../../login.html',
		                id: 'login'
		              });

		              var lauchFlag = plus.storage.getItem('lauchFlag');
		              plus.storage.clear();
		              plus.storage.setItem('lauchFlag', lauchFlag);
		            }
		            mui('#logout').button('reset');
		            mui('#topPopover').popover('hide');
		          },
		          error: function (xhr, type, errorThrown) {
		            onNetChange();
		            mui('#logout').button('reset');
		          }
		        });
		      });
		    });
		  }
		});

		function refreshUserInfo() {
		  mui.ajax(apiUrl.login, {
		    data: {
		      user_name: plus.storage.getItem('user_name'),
		      signature: plus.storage.getItem('signature')
		    },
		    dataType: 'json',
		    type: 'post',
		    timeout: 20000,
		    success: function (data) {
		      console.log('此页面请求回来的数据为：' + JSON.stringify(data));
		      if (data.status === 0) {
		        var _data = data;
		        vm.realName = _data.realName;
		        vm.workGroup = _data.additionalInfo.wrokGroup !== 'undefined' ? _data.additionalInfo.wrokGroup : '暂无分组';
		      } else {
		        plus.nativeUI.toast(data.info);
		        setTimeout(function () {
		          plus.nativeUI.closeWaiting();
		        }, 1000);
		      }
		    },
		    error: function (xhr, type, errorThrown) {
		      // 异常处理；
		      onNetChange();
		      plus.nativeUI.closeWaiting();
		    }
		  });
		}

		window.addEventListener('refreshMePageInfo', function () {
		  console.log('刷新MePageInfo页面数据.....');
		  refreshUserInfo();
		});
		window.addEventListener('closeTopPopover', function () {
		  mui('#topPopover').popover('hide');
		  if (event.detail.id === 'app/console/me.html') {
		    refreshUserInfo();
		  }
		});
	</script>
</body>

</html>