<!DOCTYPE html>
<html class="ui-page-login">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title>地图</title>
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link href="../../css/custom.css" rel="stylesheet" />
  <link href="../../js/v5.0.3-dist/ol.css" rel="stylesheet" />
  <link href="../../css/ol3-layerswitcher.css" rel="stylesheet" />
  <link href="../../js/overlay/popupoverlay.css" rel="stylesheet">
  <link href="../../css/map.css" rel="stylesheet" />
  <link href="../../css/iconfont.css" rel="stylesheet" />
  <script src="../js/jquery.js"></script>
  <style>
    body {
      background: #fff;
      font-size: 20px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .mui-bar-nav.mui-bar .mui-icon {
      margin-top: 20px;
      padding-right: 14px;
    }

    .icon-list {
      font-size: 30px;
    }

    #topPopover1 .mui-popover-arrow {
      left: 146px !important;
    }

    #topPopover2 .mui-popover-arrow {
      left: 242px !important;
    }

    .s-map-wrap {
      padding-top: 73px;
    }

    #topPopover .mui-table-view-cell a {
      display: flex;
      align-items: center;
      font-size: 20px;
    }

    #topPopover .mui-table-view-cell a img {
      margin-right: 20px;
    }

    #topPopover .mui-table-view-cell {
      border-bottom: 1px solid #706f71;
    }

    .mui-popover {
      height: 300px;
    }

    .mui-popover {
      width: 180px;
      height: 166px;
      box-shadow: 0 0 15px rgba(0, 0, 0, .3);
      background: white;
    }

    #topPopover2 {
      width: 280px;
      height: 256px;
      font-size: 13px;
    }

    #topPopover2 .mui-scroll-wrapper,
    #topPopover2 .mui-scroll-wrapper .mui-table-view-cell {
      background: white;
    }

    #topPopover2 ul li {
      padding: 0;
      height: 54px;
      display: flex;
      align-items: center;
      position: relative;
    }

    #topPopover2 ul li .line {
      width: 100%;
      height: 1px;
      background: #ccc;
      -webkit-transform: scaleY(.5);
      transform: scaleY(.5);
      position: absolute;
      top: 54px;
      left: 0;
    }

    #topPopover2 ul li span {
      width: 65px;
      text-align: right;
    }

    #topPopover2 ul li input {
      flex: 1;
      margin-bottom: 0;
      border: none;
      padding-left: 0;
      font-size: 15px;
    }

    #topPopover2 ul :nth-child(4) {
      display: flex;
      margin-top: 25px;
      padding: 0 20px;
    }

    #topPopover2 ul li span {
      /*display: block;*/
    }

    #topPopover2 ul li div {
      text-align: center;
      display: flex;
      align-items: center;
    }

    #topPopover2 ul li div .mui-checkbox label {
      line-height: 20px;
      padding-top: 8px;
      padding-bottom: 8px;
      font-size: 15px;
      padding-left: 32px;
      padding-right: 20px;
    }

    .mui-checkbox.mui-left input[type=checkbox],
    .mui-radio.mui-left input[type=radio] {
      left: 0;
    }

    #topPopover2 ul li div button,
    #topPopover2 ul li button {
      margin-right: 15px;
      background: #ccc;
      color: white;
      width: 80px;
      margin-bottom: 10px;
    }

    #topPopover2 ul li>button {
      height: 36px;
      width: 50%;
      margin: 0;
      border-radius: 4px;
      border: none;
      font-size: 16px;
    }

    #topPopover2 ul li div .active,
    #topPopover2 ul li .active {
      background: #0b60de;
    }

    #topPopover2 .group_title {
      min-width: 65px;
      font-size: 15px;
      color: #999;
      padding-left: 20px;
      margin-right: 20px;
    }

    #topPopover2 .group {}

    #topPopover2 .mui-scroll-wrapper {
      border-radius: 4px;
    }

    #topPopover2 button {
      border-radius: 4px;
      color: white;
    }

    #topPopover2 .reset {
      background: #3b88fb;
      margin-right: 15px;
    }

    #topPopover2 .reset:active {
      background: #0b5fde;
    }

    #topPopover2 .finish {
      background: #00b58f;
    }

    #topPopover2 .finish:active {
      background: #1a9b81;
    }

    .mui-popover .mui-table-view {
      background: white;
      ;
    }

    .mui-backdrop {
      background: transparent;
    }

    .mui-popover .mui-scroll-wrapper {
      margin: 0;
    }

    .mui-popover .mui-table-view .mui-table-view-cell:last-child,
    .mui-popover .mui-table-view .mui-table-view-cell:last-child,
    .mui-popover .mui-table-view .mui-table-view-cell:last-child>a:not(.mui-btn),
    .mui-popover .mui-table-view .mui-table-view-cell:first-child>a:not(.mui-btn) {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }

    .mui-popover .mui-popover-arrow:after {
      background: white;
    }

    .mui-popover .mui-table-view {
      border-radius: 7px;
    }

    .popup-info {
      padding: 0;
      text-align: left;
      width: 170px;
    }

    .popup-info p {
      color: #000;
      margin-bottom: 0;
      height: 28px;
      line-height: 34px;
      font-size: 14px;
    }

    .popup-info p span {
      display: block;
      padding: 0 10px;
      height: 28px;
      line-height: 31px;
      color: #333;
    }

    .popup-info p:after {
      width: 100%;
      height: 1px;
      content: '';
      display: block;
      padding: 0;
      position: relative;
      -webkit-transform: scaleY(.5);
      transform: scaleY(.5);
      background-color: #ccc;
    }

    p button {
      border-radius: 0;
      border: none;
      width: 70px;
      height: 35px;
    }

    #real {
      margin-left: 10px;
      margin-right: 10px;
      margin-top: 10px;
    }

    #history,
    #real {
      border: 1px solid #ccc;
      margin-top: 10px;
    }

    #history:active,
    #real:active {
      background: #0b5fde;
      border: none;
    }

    .icon-related,
    .icon-sign-out {
      color: #666;
      width: 15px !important;
      height: 22px !important;
      font-size: 20px !important;
      margin-right: 10px;
      position: relative;
      top: 3px;
    }

    .mui-popover {
      width: 122px;
      height: 50px;
      box-shadow: 0 0 15px rgba(0, 0, 0, .3);
      background: white;
    }

    .ol-popup .closeBox {
      margin: 2px 2px 0 0;
      background-color: white;
      color: #333;
    }

    .ol-popup .closeBox:after {
      content: "\00d7";
      font-size: 30px;
      /*font-family:"bodoni mt";*/
      font-family: fantasy;
      color: #999;
    }

    .mui-popover .mui-table-view .mui-table-view-cell:first-child {
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    .mui-table-view-cell {
      padding: 11px 15px;
    }

    .mui-table-view-cell:after {
      height: 0;
    }

    .ol-popup.default {
      border: 1px solid #0b60de;
      border-radius: 4px;
    }

    .ol-popup .content {
      padding: 0;
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a id="menu2" class="mui-icon mui-pull-right" href="#topPopover2">
      <span class="icon-list"></span>
    </a>
    <h1 class="mui-title">南方云</h1>
  </header>
  <div class="mui-content">
    <div class="s-map-wrap">
      <div style="height: 100%;" id="map"> </div>
    </div>

    <div id="app">

      <!--右上角弹出菜单-->
      <div id="topPopover2" class="mui-popover">
        <div class="mui-popover-arrow"></div>
        <div class="mui-scroll-wrapper">
          <div class="mui-scroll">
            <ul>
              <li>
                <span class="group_title">工作组</span>
                <select name="" v-model="workGroupValue" style="margin-bottom: 0; padding: 0" @change="checkedGroup">
                  <option value="ALL">全部</option>
                  <option v-for="item in workGroup" :value="item">{{item}}</option>
                </select>
                <div class="line"></div>
              </li>
              <li>
                <span class="group_title">机身号</span>
                <input v-model="equipmentNum" type="text" placeholder="请输入机身号" />
                <div class="line"></div>
              </li>
              <li>
                <span class="group_title">状态</span>
                <div>
                  <div class="mui-input-row mui-checkbox mui-left">
                    <label>在线</label>
                    <input name="checkbox" type="checkbox" v-model="equipmentOnline">
                  </div>
                  <div class="mui-input-row mui-checkbox mui-left">
                    <label>离线</label>
                    <input name="checkbox" type="checkbox" v-model="equipmentOffline">
                  </div>
                </div>
                <div class="line"></div>
              </li>
              <li>
                <button class="reset" id="reset">重置</button>
                <button class="finish" id="set">完成</button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../../js/v5.0.3-dist/ol.js"></script>
  <script src="../../js/ol3-layerswitcher.js"></script>
  <script src="../../js/overlay/popupoverlay.js"></script>
  <script src="../../js/mui.min.js"></script>
  <script src="../../js/app.js"></script>
  <script src="../../js/url.js"></script>
  <script src="../../js/vue.min.js"></script>
  <script type="text/javascript">
    var popup = null;
    var urlAdd, oldValue;
    var monitorUrlAddress = '';
    var monitorUrlAddressUserId = '';
    var initMapurl = '';
    var identifyCode = '';
    var status = '';
    var companyInfo = '';

    var vm = new Vue({
      el: '#app',
      data: {
        workGroupValue: 'ALL',
        workGroup: [],
        equipmentNum: '',
        equipmentOnline: true,
        equipmentOffline: true,
        groupUser: []
      },
      methods: {
        checkedGroup: function () {
          if (this.workGroupValue === 'ALL') {
            this.groupUser = [];
            return false;
          }
          oldValue = this.workGroupValue;
          plus.nativeUI.showWaiting();
          mui.ajax(apiUrl.stuff_lists, {
            data: {
              user_name: plus.storage.getItem('user_name'),
              token: plus.storage.getItem('token'),
              num_per_page: 50,
              filter_sub_name: '',
              filter_work_group: vm.workGroupValue
            },
            dataType: 'json',
            type: 'post',
            timeout: 10000,
            success: function (data) {
              if (data.status === 0) {
                if (data.totalCount === 0) {
                  mui.toast('没有匹配的用户信息！');
                } else {
                  data.recordList.forEach(function (v, k) {
                    // vm.groupUser.push("'" + v.id + "'");
                    vm.groupUser.push(v.id);
                  });
                }
              }
              plus.nativeUI.closeWaiting();
            },
            error: function (xhr, type, errorThrown) {
              // 异常处理；
              // onNetChange();
              mui.toast('切换工作组失败!');
              vm.this.workGroupValue = oldValue;
              plus.nativeUI.closeWaiting();
            }
          });
        }
      },
      created: function () { }
    });

    // 获取设备图层加载的数据源 url
    mui.plusReady(function () {
      /* 初始化mui控件 */
      mui.init({
        beforeback: function () { }
      });
      getworkGroup();

      plus.webview.currentWebview().setStyle({
        softinputMode: 'adjustResize' // 弹出软键盘时自动改变webview的高度
      });

      var mapUrl = plus.storage.getItem('monitor');
      monitorUrlAddress = mapUrl.substr(0, mapUrl.lastIndexOf('=') + 1);
      monitorUrlAddressUserId = mapUrl.substr(mapUrl.lastIndexOf(':') + 1);
      initMapurl = monitorUrlAddress + 'state1:1;state2:0' + "&cql_filter=user_id in ('" + monitorUrlAddressUserId + "')";
      // 天地图加载资源
      var tianDiTuMapLayer = new ol.layer.Tile({
        title: '天地图路网',
        preload: Infinity,
        source: new ol.source.XYZ({
          url: 'http://t4.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}'
        })
      });
      var tianDiTuAnnotation = new ol.layer.Tile({
        title: '天地图文字标注',
        source: new ol.source.XYZ({
          url: 'http://t3.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}'
        })
      });
      /*  var tianDiTuSatellite = new ol.layer.Tile({
        title: '天地图卫星影像',
        source: new ol.source.XYZ({
          url: 'http://t3.tianditu.com/DataServer?T=img_w&x={x}&y={y}&l={z}'
        })
      }); */

      // 设备图层资源
      /*  var vectorSource = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: monitorUrlAddress + ';state1:1;state2:1'
      }); */
      var device_vector_layer = new ol.layer.Vector({
        source: new ol.source.Vector({
          format: new ol.format.GeoJSON(),
          url: initMapurl
        }),
        style: function (feature, resolution) {
          var featureProperties = feature.getProperties();
          if (featureProperties === null || featureProperties === undefined) return pointOfflineStyle;
          return featureProperties.online_status === 1 ? pointOnlineStyle : pointOfflineStyle;
        }
      });
      document.getElementById('reset').addEventListener('tap', function () {
        vm.groupUser = [];
        vm.workGroupValue = 'ALL';
        vm.equipmentNum = '';
        vm.equipmentOnline = false;
        vm.equipmentOffline = false;
        filterMapData(initMapurl);
        mui('#topPopover2').popover('hide');
      });
      document.getElementById('menu2').addEventListener('tap', function () {
        getworkGroup();
      });
      document.getElementById('set').addEventListener('tap', function () {
        console.log(vm.groupUser);
        urlAdd = '';
        if (vm.groupUser.length === 0) {
          if (vm.equipmentNum === '') {
            if (vm.equipmentOnline === true && vm.equipmentOffline === true) {
              urlAdd = 'state1:1;state2:0';
            } else if (vm.equipmentOnline === true && vm.equipmentOffline === false) {
              urlAdd = 'state1:1;state2:1';
            } else if (vm.equipmentOnline === false && vm.equipmentOffline === true) {
              urlAdd = 'state1:0;state2:0';
            }
          } else {
            if (vm.equipmentOnline === true && vm.equipmentOffline === true) {
              urlAdd = 'state1:1;state2:0;code:' + vm.equipmentNum;
            } else if (vm.equipmentOnline === true && vm.equipmentOffline === false) {
              urlAdd = 'state1:1;state2:1;code:' + vm.equipmentNum;
            } else if (vm.equipmentOnline === false && vm.equipmentOffline === true) {
              urlAdd = 'state1:0;state2:0;code:' + vm.equipmentNum;
            } else {
              urlAdd = 'state1:1;state2:0;code:' + vm.equipmentNum;
            }
          }
          urlAdd += "&cql_filter=user_id in ('" + monitorUrlAddressUserId + "')";
        } else {
          if (vm.equipmentNum === '') {
            if (vm.equipmentOnline === true && vm.equipmentOffline === true) {
              urlAdd = 'state1:1;state2:0';
            } else if (vm.equipmentOnline === true && vm.equipmentOffline === false) {
              urlAdd = 'state1:1;state2:1';
            } else if (vm.equipmentOnline === false && vm.equipmentOffline === true) {
              urlAdd = 'state1:0;state2:0';
            }
          } else {
            if (vm.equipmentOnline === true && vm.equipmentOffline === true) {
              urlAdd = 'state1:1;state2:0;code:' + vm.equipmentNum;
            } else if (vm.equipmentOnline === true && vm.equipmentOffline === false) {
              urlAdd = 'state1:1;state2:1;code:' + vm.equipmentNum;
            } else if (vm.equipmentOnline === false && vm.equipmentOffline === true) {
              urlAdd = 'state1:0;state2:0;code:' + vm.equipmentNum;
            } else {
              urlAdd = 'state1:1;state2:0;code:' + vm.equipmentNum;
            }
          }
          urlAdd += "&cql_filter=user_id in ('" + vm.groupUser.join(',') + "')";
        }
        filterMapData(monitorUrlAddress + urlAdd);
        mui('#topPopover2').popover('hide');
      });

      // 设备在线样式
      var pointOnlineStyle = new ol.style.Style({
        image: new ol.style.Icon({
          src: '../../public/img/device_online.png',
          anchor: [0.5, 0.5] // 设置图标位置
        })
      });

      // 设备离线样式
      var pointOfflineStyle = new ol.style.Style({
        image: new ol.style.Icon({
          src: '../../public/img/device_offline.png',
          anchor: [0.5, 0.5] // 设置图标位置
        })
      });

      /**
       * 调用外部的JS创建弹出框
       * Create xiaoJing 2017年11月7日 09:34:25
       */
      popup = new ol.Overlay.Popup({
        popupClass: 'default', // "tooltips", "warning" "black" "default", "tips", "shadow",
        closeBox: true,
        positioning: 'bottom-center',
        autoPan: true,
        autoPanAnimation: {
          duration: 250
        }
      });

      var olMap = new ol.Map({
        // 图层
        layers: [
          tianDiTuMapLayer, tianDiTuAnnotation, device_vector_layer
          // tianDiTuOfflineGuangzhowRoadmap, tianDiTuOfflineGuangzhowOverlay_r
        ],
        overlays: [popup],
        target: 'map',
        // 禁止在移动端旋转设备
        interactions: ol.interaction.defaults({
          altShiftDragRotate: false,
          pinchRotate: false,
          doubleClickZoom: false
        }),
        controls: ol.control.defaults({
          attributionOptions: ({
            collapsible: false
          }),
          attribution: false,
          // 不显示旋转控件
          rotate: false,
          // 不显示缩放控件
          zoom: false
        }).extend([
          // 添加比例尺控制到地图上
          new ol.control.ScaleLine()
        ]),
        view: new ol.View({
          // 指定投影使用EPSG:4326
          projection: 'EPSG:4326',
          constrainRotation: false,
          enableRotation: false,
          center: [113.2652664185, 23.1349929688],
          zoom: 8,
          minZoom: 0,
          maxZoom: 24
        })
      });

      // 地图中心调用函数
      function mapCenter(position, zoom) {
        olMap.getView().animate({
          center: position,
          zoom: zoom,
          duration: 0
        });
      }

      //  根据数据源的坐标组来判断缩放级别
      function fitCenter(coordinates) {
        var boundingExtent = ol.extent.boundingExtent(coordinates);
        olMap.getView().fit(boundingExtent, olMap.getSize());
      }

      var FeaturesArr = '';
      // 加载完设备图层的回调
      device_vector_layer.getSource().once('change', function () {
        if (device_vector_layer.getSource().getState() === 'ready') {
          FeaturesArr = device_vector_layer.getSource().getFeatures();
          var coordinatesArr = [];
          for (var i = 0; i < FeaturesArr.length; i++) {
            if (FeaturesArr[i].getGeometry()) {
              if (FeaturesArr[i].getGeometry().getCoordinates().length > 0) {
                coordinatesArr.push(FeaturesArr[i].getGeometry().getCoordinates());
              }
            }
          }
          mapCenter([115.2652664185, 28.1349929688], 5);
        }
      });

      //  绑定地图上的单击事件
      olMap.on('singleclick', function (evt) {
        if (evt.dragging) {
          return;
        }
        var pixel = olMap.getEventPixel(evt.originalEvent);
        //  获取当前点击位置的图层
        var feature = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {
          return feature;
        });
        if (feature === null || feature === undefined) return;
        // 获取图层信息
        displayDeviceInfoOverlay(feature);
      }, device_vector_layer);

      function displayDeviceInfoOverlay(selectFeature) {
        popup.hide();
        if (selectFeature === undefined) return;
        var deviceItemInfo = selectFeature.getProperties();
        if (deviceItemInfo === undefined) return;

        identifyCode = deviceItemInfo.identify_code;
        status = deviceItemInfo.online_status;
        var content = '<div class="popup-info">';
        content += '<p>' + '<span>&nbsp;' + '</span>' + '</p>';
        content += '<p>' + '<span>' + deviceItemInfo.identify_code + '</span>' + '</p>';
        var upDataCompanyInfo = deviceItemInfo.up_data_company_info ? deviceItemInfo.up_data_company_info : '-';
        var upDataUserName = deviceItemInfo.up_data_user_name ? deviceItemInfo.up_data_user_name : '-';
        companyInfo = upDataCompanyInfo;
        content += '<p>' + '<span>' + upDataUserName + '</span>' + '</p>';
        content += '<p>' + '<span>' + upDataCompanyInfo + '</span>' + '</p></div>';
        content += '<p><button id="real" style="margin-right:8px">实时轨迹</button><button id="history">历史轨迹</button></p></div>';

        popup.show(selectFeature.getGeometry().getCoordinates(), content);
      }

      // 筛选地图显示设备功能
      function filterMapData(getMapUrl) {
        console.log(getMapUrl);
        popup.hide();
        plus.nativeUI.showWaiting();
        mui.ajax(getMapUrl, {
          dataType: 'json',
          type: 'get',
          success: function (datas) {
            if (FeaturesArr && FeaturesArr.length > 0) {
              for (var i = 0; i < FeaturesArr.length; i++) {
                device_vector_layer.getSource().removeFeature(FeaturesArr[i]);
              }
            }
            if (datas.totalFeatures === 0) {
              FeaturesArr = '';
              mui.toast('暂无搜索到的设备!');
            } else {
              var features = (new ol.format.GeoJSON()).readFeatures(datas);
              device_vector_layer.getSource().addFeatures(features);
              var pointArr = [];
              for (var i = 0; i < features.length; i++) {
                if (features[i].getGeometry()) {
                  if (features[i].getGeometry().getCoordinates().length > 0) {
                    pointArr.push(features[i].getGeometry().getCoordinates());
                  }
                }
              }
              if (pointArr.length === 1) {
                mapCenter(pointArr[0], 8);
              } else {
                fitCenter(pointArr);
              }
              FeaturesArr = features;
            }
            plus.nativeUI.closeWaiting();
          },
          error: function (xhr, type, errorThrown) {
            // 异常处理；
            onNetChange();
            plus.nativeUI.closeWaiting();
          }

        });
      }
      /* window.addEventListener('closeTopPopover', function (event) {
        if (event.detail.id === 'app/console/map.html') {
          if (url) {
            filterMapData(url);
          } else {
            filterMapData(initMapurl);
          }
        }
      }); */
    });

    $(document).on('click', '#history', function () {
      popup.hide();
      mui.openWindow({
        url: '../personnel/historicalTrack.html',
        id: '../personnel/historicalTrack.html',
        extras: {
          identifyCode: identifyCode,
          upDataCompanyInfo: companyInfo,
          item: {
            identifyCode: identifyCode
          }
        }
      });
    });

    $(document).on('click', '#real', function () {
      if (status == 0) {
        mui.toast('设备离线!');
      } else {
        popup.hide();
        mui.openWindow({
          url: '../personnel/realTimeTrack.html',
          id: '../personnel/realTimeTrack.html',
          extras: {
            identifyCode: identifyCode,
            item: {
              identifyCode: identifyCode
            }
          }
        });
      }
    });

    function getworkGroup() {
      mui.ajax(apiUrl.get_work_group, {
        data: {
          user_name: plus.storage.getItem('user_name'),
          token: plus.storage.getItem('token')
        },
        dataType: 'json',
        type: 'post',
        timeout: 20000,
        success: function (data) {
          if (data.groupList === null || data.groupList.length === 0) {
            vm.hasResult = false;
            mui.toast('该账户下没有工作组信息');
          } else {
            vm.hasResult = true;
            var tempGroup = [];
            var tempData = data.groupList;
            for (var i = 0; i < tempData.length; i++) {
              if (tempGroup.indexOf(tempData[i]) == -1) {
                tempGroup.push(tempData[i]);
              }
            }
            vm.workGroup = tempGroup;
          }
        }
      });
    }
  </script>
</body>

</html>