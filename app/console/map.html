<!DOCTYPE html>
<html class="ui-page-login">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>地图</title>
	<link href="../../css/mui.min.css" rel="stylesheet" />
	<link href="../../css/custom.css" rel="stylesheet" />
	<link href="../../css/input.css" rel="stylesheet" />
	<link href="../../css/ol.css" rel="stylesheet" />
	<link href="../../css/ol3-layerswitcher.css" rel="stylesheet" />
	<link href="../../js/overlay/popupoverlay.css" rel="stylesheet">
	<link href="../../css/map.css" rel="stylesheet" />
	<script src="../js/jquery.js"></script>
	<style>
		body {
			background: #fff;
			font-size: 20px;
		}

		ul {
			list-style: none;
			padding: 0;
			margin: 0;
		}

		.mui-bar-nav.mui-bar :nth-child(1) {
			position: relative;
		}

		.mui-bar-nav.mui-bar :nth-child(2) {
			font-size: 20px;
			padding: 10px 10px;
			position: relative;
			top: 26px;
			left: -10px;
		}

		#topPopover1 .mui-popover-arrow {
			left: 146px !important;
		}

		#topPopover2 .mui-popover-arrow {
			left: 205px !important;
		}

		.s-map-wrap {
			padding-top: 73px;
		}

		#topPopover .mui-table-view-cell a {
			display: flex;
			align-items: center;
			font-size: 20px;
		}

		#topPopover .mui-table-view-cell a img {
			margin-right: 20px;
		}

		#topPopover .mui-table-view-cell {
			border-bottom: 1px solid #706f71;
		}

		.mui-popover {
			height: 300px;
		}

		.mui-popover {
			width: 180px;
			height: 166px;
			box-shadow: 0 0 15px rgba(0, 0, 0, .3);
			background: white;
		}

		#topPopover2 {
			width: 280px;
			height: 278px;
		}

		#topPopover2 .mui-scroll-wrapper,
		#topPopover2 .mui-scroll-wrapper .mui-table-view-cell {
			background: white;
		}

		#topPopover2 ul li {
			padding: 0;
			border-bottom: 1px solid #ccc;
		}

		#topPopover2 ul :nth-child(4) {
			display: flex;
			padding-top: 60px;
		}

		#topPopover2 ul li span {
			display: block;
		}

		#topPopover2 ul li div {
			text-align: center;
		}

		#topPopover2 ul li div button,
		#topPopover2 ul li button {
			margin-right: 15px;
			background: #ccc;
			color: white;
			width: 80px;
			margin-bottom: 10px;
		}

		#topPopover2 ul li>button {
			height: 46px;
			width: 50%;
			margin: 0;
			border-radius: 0;
			border: none;
		}

		#topPopover2 ul li div .active,
		#topPopover2 ul li .active {
			background: #0b60de;
		}

		#topPopover2 .group_title {
			font-size: 13px;
			color: #999;
			padding-left: 5px;
			padding-top: 2px;
		}

		#topPopover2 .group {
			padding-left: 20px;
			padding-top: 2px;
			padding-bottom: 6px;
		}

		#topPopover2 .mui-scroll-wrapper {
			border-radius: 0;
		}

		.mui-popover .mui-table-view {
			background: white;
			;
		}

		.mui-backdrop {
			background: transparent;
		}

		.mui-popover .mui-scroll-wrapper {
			margin: 0;
		}

		.mui-popover .mui-table-view .mui-table-view-cell:last-child,
		.mui-popover .mui-table-view .mui-table-view-cell:last-child,
		.mui-popover .mui-table-view .mui-table-view-cell:last-child>a:not(.mui-btn),
		.mui-popover .mui-table-view .mui-table-view-cell:first-child>a:not(.mui-btn) {
			border-bottom-left-radius: 0;
			border-bottom-right-radius: 0;
			border-top-left-radius: 0;
			border-top-right-radius: 0;
		}

		.mui-popover .mui-popover-arrow:after {
			background: white;
		}

		#topPopover1 .mui-table-view-cell {
			border-bottom: 1px solid #ddd;
		}

		.mui-popover .mui-table-view {
			border-radius: 0;
		}

		.popup-info {
			padding: 6px 6px 0 6px;
			text-align: left;
		}

		.popup-info p {
			color: #fff;
		}
	</style>
</head>

<body>
	<div id="app">
		<header class="mui-bar mui-bar-nav">
			<a id="menu" class="mui-action-menu mui-icon mui-icon-plusempty mui-pull-right lists" href="#topPopover1"></a>
			<a id="menu" class="mui-action-menu mui-icon mui-icon-bars mui-pull-right" href="#topPopover2"></a>
			<h1 class="mui-title">南方云</h1>
		</header>
		<div class="mui-content">
			<div class="s-map-wrap">
				<div style="height: 100%;" id="map" class="map"> </div>
			</div>
		</div>

		<!--右上角弹出菜单1-->
		<div id="topPopover1" class="mui-popover">
			<div class="mui-popover-arrow" style="left:130px"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" href="../personnel/userEntry.html">
							<a href="#">
								<img src="../../public/img/related.png" alt="" />
								<span>设备关联</span>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<!--右上角弹出菜单2-->
		<div id="topPopover2" class="mui-popover">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul>
						<li>
							<span class="group_title">工作组</span>
							<span class="group">白云组</span>
						</li>
						<li>
							<span class="group_title">机身号</span>
							<span class="group">5468456565465</span>
						</li>
						<li>
							<span class="group_title">状态</span>
							<div>
								<button class="active">在线</button>
								<button>离线</button>
							</div>

						</li>
						<li>
							<button>重置</button>
							<button class="active">完成</button>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<script src="../../js/ol.js"></script>
	<script src="../../js/ol3-layerswitcher.js"></script>
	<script src="../../js/overlay/popupoverlay.js"></script>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/url.js"></script>
	<script src="../../js/vue.min.js"></script>
	<script type="text/javascript">
		var user_name = '';
		var token = '';
		// 获取设备图层加载的数据源 url
		var monitorUrlAddress = '';
		var map_id_prefix = '';

		mui.plusReady(function () {
		  /* 初始化mui控件 */
		  mui.init({
		    beforeback: function () { }
		  });

		  plus.webview.currentWebview().setStyle({
		    softinputMode: 'adjustResize' // 弹出软键盘时自动改变webview的高度
		  });

		  user_name = plus.storage.getItem('user_name');
		  token = plus.storage.getItem('token');

		  mui.ajax(apiUrl.map_url, {
		    data: {
		      user_name: user_name,
		      token: token
		    },
		    dataType: 'json',
		    type: 'post',
		    timeout: 10000,
		    success: function (data) {
		      if (data.status === 0) {
		        monitorUrlAddress = data.map_monitor;
		        map_id_prefix = data.map_id_prefix;
		        showMap();
		      } else {
		        mui.toast(data.info);
		      }
		    },
		    error: function (xhr, type, errorThrown) {
		      onNetChange();
		    }
		  });

		  function showMap() {
		    // 天地图加载资源
		    var tianDiTuMapLayer = new ol.layer.Tile({
		      title: '天地图路网',
		      preload: Infinity,
		      source: new ol.source.XYZ({
		        url: 'http://t4.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}'
		      })
		    });
		    var tianDiTuAnnotation = new ol.layer.Tile({
		      title: '天地图文字标注',
		      source: new ol.source.XYZ({
		        url: 'http://t3.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}'
		      })
		    });
		    var tianDiTuSatellite = new ol.layer.Tile({
		      title: '天地图卫星影像',
		      source: new ol.source.XYZ({
		        url: 'http://t3.tianditu.com/DataServer?T=img_w&x={x}&y={y}&l={z}'/**/
		      })
		    });

		    // 设备图层资源
		    var device_vector_layer = new ol.layer.Vector({
		      source: new ol.source.Vector({
		        format: new ol.format.GeoJSON(),
		        // VIEWPARAMS: 'userId:' + userId,
		        url: monitorUrlAddress
		      }),
		      style: function (feature, resolution) {
		        var featureProperties = feature.getProperties();
		        if (featureProperties === null || featureProperties === undefined) return pointOfflineStyle;
		        return featureProperties.online_status === 1 ? pointOnlineStyle : pointOfflineStyle;
		      }
		    });

		    // 设备在线样式
		    var pointOnlineStyle = new ol.style.Style({
		      image: new ol.style.Icon({
		        src: '../../public/img/device_online.png',
		        anchor: [0.5, 0.5] // 设置图标位置
		      })
		    });

		    // 设备离线样式
		    var pointOfflineStyle = new ol.style.Style({
		      image: new ol.style.Icon({
		        src: '../../public/img/device_offline.png',
		        anchor: [0.5, 0.5] // 设置图标位置
		      })
		    });

		    /* var device_vector_layer_online = new ol.layer.Vector({
		      source: new ol.source.Vector({
		        format: new ol.format.GeoJSON(),
		        url: monitorUrlAddress
		      }),
		      style: function (feature, resolution) {
		        var featureProperties = feature.getProperties();
		        if (featureProperties === null || featureProperties === undefined) return;
		        if (featureProperties.online_status === 1) {
		          return pointOnlineStyle;
		        }
		      }
				}); */

		    // 比例尺控件
		    var scaleLineControl = new ol.control.ScaleLine();

		    /**
				* 调用外部的JS创建弹出框
				* Create xiaoJing 2017年11月7日 09:34:25
				*/
		    var popup = new ol.Overlay.Popup({
		      popupClass: 'black', // "tooltips", "warning" "black" "default", "tips", "shadow",
		      closeBox: true,
		      positioning: 'auto',
		      autoPan: true,
		      autoPanAnimation: { duration: 250 }
		    });

		    var olMap = new ol.Map({
		      // 图层
		      layers: [
		        tianDiTuMapLayer, tianDiTuAnnotation, device_vector_layer
		        // tianDiTuOfflineGuangzhowRoadmap, tianDiTuOfflineGuangzhowOverlay_r
		      ],
		      overlays: [popup],
		      target: 'map',
		      // 禁止在移动端旋转设备
		      interactions: ol.interaction.defaults({ altShiftDragRotate: false, pinchRotate: false }),
		      controls: ol.control.defaults({
		        attributionOptions: ({
		          collapsible: false

		        }),
		        attribution: false,
		        // 不显示旋转控件
		        rotate: false,
		        // 不显示缩放控件
		        zoom: false
		      }).extend([
		        // 添加比例尺控制到地图上
		        scaleLineControl
		      ]),
		      view: new ol.View({
		        // 指定投影使用EPSG:4326
		        projection: 'EPSG:4326',
		        constrainRotation: false,
		        enableRotation: false,
		        center: [113.2652664185, 23.1349929688],
		        zoom: 8,
		        minZoom: 0,
		        maxZoom: 24
		      })
		    });

		    // 地图中心调用函数
		    function mapCenter(position, zoom) {
		      olMap.getView().animate({
		        center: position,
		        duration: 1500,
		        zoom: zoom
		      });
		    }

		    //  根据数据源的坐标组来判断缩放级别
		    function fitCenter(coordinates) {
		      var boundingExtent = ol.extent.boundingExtent(coordinates);
		      olMap.getView().fit(boundingExtent, olMap.getSize());
		    }

		    // 加载完设备图层的回调
		    device_vector_layer.getSource().on('change', function () {
		      if (device_vector_layer.getSource().getState() === 'ready') {
		        var FeaturesArr = device_vector_layer.getSource().getFeatures();
		        var coordinatesArr = [];
		        for (var i = 0; i < FeaturesArr.length; i++) {
		          if (FeaturesArr[i].getGeometry()) {
		            if (FeaturesArr[i].getGeometry().getCoordinates().length > 0) {
		              coordinatesArr.push(FeaturesArr[i].getGeometry().getCoordinates());
		            }
		          }
		        }
		        fitCenter(coordinatesArr);
		        // device_vector_layer.getSource().unByKey(listenerKey); // 注销监听器
		      }
		    });

		    //  绑定地图上的单击事件
		    olMap.on('singleclick', function (evt) {
		      if (evt.dragging) {
		        return;
		      }
		      var pixel = olMap.getEventPixel(evt.originalEvent);
		      //  获取当前点击位置的图层
		      var feature = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {
		        return feature;
		      });
		      if (feature === null || feature === undefined) return;
		      // 获取图层信息
		      displayDeviceInfoOverlay(feature);
		    }, device_vector_layer);

		    function displayDeviceInfoOverlay(selectFeature) {
		      popup.hide();
		      if (selectFeature === undefined) return;
		      var deviceItemInfo = selectFeature.getProperties();
		      if (deviceItemInfo === undefined) return;
		      var content = '<div class="popup-info">';
		      content += '<p>设备编号:' + deviceItemInfo.identify_code + '</p>';
		      if (deviceItemInfo.online_status === 1) {
		        content += '<p>连接时间:' + timeTrans(deviceItemInfo.connect_time, 'yyyy-MM-dd HH:mm:ss') + '</p>';
		      } else {
		        content += '<p>断开时间:' + timeTrans(deviceItemInfo.disconnect_time, 'yyyy-MM-dd HH:mm:ss') + '</p>';
		      }
		      var upDataUserName = deviceItemInfo.up_data_user_name ? deviceItemInfo.up_data_user_name : '-';
		      var upDataCompanyInfo = deviceItemInfo.up_data_company_info ? deviceItemInfo.up_data_company_info : '-';
		      content += '<p>经度:' + formatDegree(deviceItemInfo.longitude) + '</p>';
		      content += '<p>纬度:' + formatDegree(deviceItemInfo.latitude) + '</p>';
		      content += '<p>用户名:' + upDataUserName + '</p>';
		      content += '<p>用户单位:' + upDataCompanyInfo + '</p></div>';

		      popup.show(selectFeature.getGeometry().getCoordinates(), content);
		    }
		  }
		});
	</script>
</body>

</html>