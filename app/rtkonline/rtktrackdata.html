<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>历史轨迹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="stylesheet" href="../../css/mui.min.css">
  <link rel="stylesheet" href="../../css/list.css">
  <style>
  .mui-table-view-cell {
    padding: 0 9px;
    height: 50px;
  }

  .mui-table-view-cell span {
    display: inline-block;
    height: 50px;
    line-height: 50px;
    width: calc((100% - 20px) / 2);
    font-size: 16px;
    color: #333;
  }

  .mui-table-view-cell span img {
    width: 16px;
    height: 16px;
    vertical-align: middle;
    margin-bottom: 4px;
    margin-right: 6px
  }

  .span-left {
    color: #999;
    text-align: right;
  }
  </style>
</head>

<body>
  <!--下拉刷新容器-->
  <div id="pullrefresh" class="mui-content mui-scroll-wrapper">
    <div class="mui-scroll">
      <div class="mui-table-view" id="show">
        <div class="mui-table-view-cell" v-for="v in list" @click="trackDay(v.identifyCode, v.trackDate, v.id, v.machineId)">
          <span class="text-hidden">
            <img src="../../public/img/time.png" alt=""> {{v.dayOnlineSeconds | formatSeconds}}
          </span>
          <span class="text-hidden span-left">
            {{v.trackDate | getTime}}
          </span>
        </div>
      </div>
    </div>
  </div>
  <script src="../../js/mui.min.js"></script>
  <script src="../../js/url.js"></script>
  <script src="../../js/vue.min.js"></script>
  <script>
  var vm = new Vue({
    el: '#pullrefresh',
    data: {
      user_name: '',
      token: '',
      identify_code: '',
      list: [],
      page: 0,
      comArray: ['确认']
    },
    methods: {
      trackDay: function (identify_code, day, trackAnalyseId, machineId) {
        day = timeTrans(day, 'yyyy-MM-dd');
        mui.openWindow({
          url: 'rtktrackday.html',
          id: 'rtktrackday.html',
          extras: {
            identify_code: identify_code,
            day: day,
            trackAnalyseId: trackAnalyseId,
            machineId: machineId
          }
        });
      }
    },
    created: function () {
      mui.plusReady(function () {
        mui.init({
          pullRefresh: {
            container: '#pullrefresh',
            up: {
              contentrefresh: '正在加载...',
              callback: pullupRefresh,
              auto: false // 可选,默认false.自动上拉加载一次
            }
          }
        });
        vm.user_name = plus.storage.getItem('user_name');
        vm.token = plus.storage.getItem('token');
        vm.identify_code = plus.storage.getItem('rtkTrackIdentify');
        rtkTrack();
      });
    },

    filters: {
      formatSeconds: function (value) {
        var theTime = parseInt(value); // 秒
        var theTime1 = 0; // 分
        var theTime2 = 0; // 小时
        if (theTime > 60) {
          theTime1 = parseInt(theTime / 60);
          theTime = parseInt(theTime % 60);
          if (theTime1 > 60) {
            theTime2 = parseInt(theTime1 / 60);
            theTime1 = parseInt(theTime1 % 60);
          }
        }
        var result = '' + parseInt(theTime) + '秒';
        if (result == '-1秒') {
          result = '暂无在线时长';
        }
        if (theTime1 > 0) {
          result = '' + parseInt(theTime1) + '分' + result;
        }
        if (theTime2 > 0) {
          result = '' + parseInt(theTime2) + '小时' + result;
        }
        return result;
      },

      getTime: function (value) {
        return timeTrans(value, 'yyyy-MM-dd');
      }
    }
  });

  function pullupRefresh() {
    setTimeout(function () {
      rtkTrack();
    }, 800);
  }

  function rtkTrack() {
    mui.ajax(apiUrl.track_info_page, {
      data: {
        user_name: vm.user_name,
        token: vm.token,
        page_num: ++vm.page,
        num_per_page: 15,
        filter_identifycode: vm.identify_code
      },
      dataType: 'json',
      type: 'post',
      timeout: 10000,
      success: function (data) {
        if (data.status == 0) {
          if (data.pageCount == 1) {
            mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
            mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
          } else if (vm.page == data.endPageIndex) {
            mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
          } else {
            mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
          }

          if (data.recordList.length === 0 && data.currentPage === 1) {
            mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
            mui.confirm('暂无数据!', 'SouthCloud', ['确认'], function (e) {
              mui.openWindow({
                url: 'rtklist.html',
                id: './app/rtkonline/rtklist.html'
              });
              var ws = plus.webview.getWebviewById('rtktrack');
              ws.close('none');
            }, 'div');
            // mui.confirm('暂无数据!', 'SouthCloud', ['确认'], function(e) {
            //   mui.openWindow({
            //     url: 'rtklist.html',
            //     id: './app/rtkonline/rtklist.html',
            //   });
            //   var ws = plus.webview.getLaunchWebview();
            //   var ws1 = plus.webview.getWebviewById('rtktrack');
            // }, 'div');
          }

          vm.list = vm.list.concat(data.recordList);
          getDom('show').style.display = 'block';
        } else if (data.status == 40004) {
          mui.toast(data.info);
          setTimeout(function () {
            mui.openWindow({
              url: '../../login.html',
              id: 'login'
            });
          }, 1500);
        } else {
          mui.toast(data.info);
        }
      },
      error: function (xhr, type, errorThrown) {
        onNetChange();
      }
    });
  }
  </script>
</body>

</html>
