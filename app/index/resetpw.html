<!DOCTYPE html>
<html class="ui-page-login">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title>重置密码</title>
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link href="../../css/custom.css" rel="stylesheet" />
  <link href="../../css/input.css" rel="stylesheet" />
</head>

<body>
  <div id="app">
    <header class="mui-bar mui-bar-nav">
      <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
      <h1 class="mui-title">修改密码</h1>
    </header>
    <div class="mui-content" style="padding-top: 70px">
      <form class="mui-input-group">
        <div class="mui-input-row">
          <label>原密码</label>
          <input type="password" placeholder="请输入原密码" v-model="oldpw">
        </div>
        <div class="mui-input-row">
          <label>新密码</label>
          <input id="pw" type="password" placeholder="请输入新密码" v-model="pw">
        </div>
        <div class="mui-input-row">
          <label>确认密码</label>
          <input id="pw1" type="password" placeholder="请确认密码" v-model="pw1">
        </div>
      </form>
      <div style="margin: 40px 20px">
        <button class="mui-btn mui-btn-block mui-btn-primary" @click="send()" id="send" data-loading-text=" ">提&nbsp;&nbsp;&nbsp;&nbsp;交</button>
      </div>
    </div>
  </div>
  <script src="../../js/mui.min.js"></script>
  <script src="../../js/app.js"></script>
  <script src="../../js/url.js"></script>
  <script src="../../js/sha1.js"></script>
  <script src="../../js/vue.min.js"></script>
  <script>
  var vm = new Vue({
    el: '#app',
    data: {
      user_name: '',
      token: '',
      oldpw: '',
      pw: '',
      pw1: ''
    },
    methods: {
      send: function() {
        if (this.oldpw === ' ') {
          mui.toast('请输入原密码！');
          return;
        }
        if (/^[0-9a-zA-Z]{6,18}$/.test(this.pw) == false) {
          mui.toast('密码为6-18个字符的数字、字母组合！');
          return;
        }
        if (this.pw != this.pw1) {
          mui.toast('两次输入的密码不一致！');
          return;
        }

        mui('#send').button('loading');
        mui.ajax(apiUrl.reset_password, {
          data: {
            user_name: vm.user_name,
            token: vm.token,
            old_password: hex_sha1(vm.oldpw),
            new_password: vm.pw,
          },
          dataType: 'json',
          type: 'post',
          timeout: 10000,
          success: function(data) {
            if (data.status === 0) {
              mui.toast('修改密码成功，请用新密码登录');
              setTimeout(function() {
                mui.openWindow({
                  url: '../../login.html',
                  id: 'login',
                });
              }, 1000);
            } else if (data.status === 40004) {
              mui.openWindow({
                url: '../../login.html',
                id: 'login',
              });
            } else {
              mui.toast(data.info);
            }
            mui('#send').button('reset');
          },
          error: function(xhr, type, errorThrown) {
            //异常处理；
            onNetChange();
            mui('#send').button('reset');
          }
        });
      }
    },
    created: function() {
      mui.plusReady(function() {
        plus.webview.currentWebview().setStyle({
          softinputMode: "adjustResize"
        });
        mui.init({});
        vm.identify_code = self.identify_code;
        vm.user_name = plus.storage.getItem("user_name");
        vm.token = plus.storage.getItem("token");
      });
    },
  });
  </script>
</body>

</html>
