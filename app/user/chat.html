<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link rel="stylesheet" href="../../css/mui.min.css">
    <script src="../../js/url.js"></script>
    <style>
    html,
    body {
        height: 100%;
        margin: 0px;
        padding: 0px;
        overflow: hidden;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
    }

    .mui-icon-paperplane:before {
        content: '';
    }

    footer {
        position: fixed;
        width: 100%;
        height: 50px;
        min-height: 50px;
        border-top: solid 1px #bbb;
        left: 0px;
        bottom: 0px;
        overflow: hidden;
        padding: 0px 50px 0 10px;
        background-color: #fafafa;
    }

    .footer-right {
        position: absolute;
        width: 50px;
        height: 50px;
        right: 0px;
        bottom: 0px;
        text-align: center;
        vertical-align: middle;
        line-height: 100%;
        padding: 12px 5px;
        display: inline-block;
    }

    .footer-center {
        height: 100%;
        width: 100%;
        padding: 5px 0px;
    }

    .footer-center [class*=input] {
        width: 100%;
        height: 100%;
        border-radius: 5px;
    }

    .footer-center .input-text {
        background: #fff;
        border: solid 1px #ddd;
        padding: 10px !important;
        font-size: 16px !important;
        line-height: 18px !important;
        font-family: verdana !important;
        overflow: hidden;
    }

    .footer-center .input-sound {
        background-color: #eee;
    }

    .mui-content {
        height: 100%;
        padding: 44px 0px 50px 0px;
        overflow: auto;
        background-color: #eaeaea;
    }

    #msg-list {
        height: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
    }

    .msg-item {
        padding: 8px;
        clear: both;
    }

    .msg-item .mui-item-clear {
        clear: both;
    }

    .msg-item .msg-user {
        width: 38px;
        height: 38px;
        border: solid 1px #d3d3d3;
        display: inline-block;
        background: #fff;
        border-radius: 3px;
        vertical-align: top;
        text-align: center;
        float: left;
        padding: 3px;
        color: #ddd;
    }

    .msg-item .msg-user-img {
        width: 38px;
        height: 38px;
        display: inline-block;
        border-radius: 3px;
        vertical-align: top;
        text-align: center;
        float: left;
        color: #ddd;
    }

    .msg-item .msg-content {
        display: inline-block;
        border-radius: 5px;
        border: solid 1px #d3d3d3;
        background-color: #FFFFFF;
        color: #333;
        padding: 8px;
        vertical-align: top;
        font-size: 15px;
        position: relative;
        margin: 0px 8px;
        max-width: 75%;
        min-width: 35px;
        float: left;
    }

    .msg-item .msg-content .msg-content-inner {
        /* overflow-x: hidden; */
        word-break: break-all;
    }

    .msg-item .msg-content .msg-content-arrow {
        position: absolute;
        border: solid 1px #d3d3d3;
        border-right: none;
        border-top: none;
        background-color: #FFFFFF;
        width: 10px;
        height: 10px;
        left: -5px;
        top: 12px;
        -webkit-transform: rotateZ(45deg);
        transform: rotateZ(45deg);
    }

    .msg-item-self .msg-user,
    .msg-item-self .msg-content {
        float: right;
    }

    .msg-item-self .msg-content .msg-content-arrow {
        left: auto;
        right: -5px;
        -webkit-transform: rotateZ(225deg);
        transform: rotateZ(225deg);
    }

    .msg-item-self .msg-content,
    .msg-item-self .msg-content .msg-content-arrow {
        background-color: #fff;
        color: #000;
        border-color: #fff;
    }

    footer .mui-icon {
        color: #AAA;
        font-size: 16px;
        line-height: 100%;
        padding-top: 6px;
    }

    footer .mui-icon:active {
        color: #007AFF !important;
    }

    footer .mui-icon-paperplane {
        /*-webkit-transform: rotateZ(45deg);
                transform: rotateZ(45deg);*/
        font-size: 16px;
        word-break: keep-all;
        line-height: 100%;
        padding-top: 6px;
        color: rgba(0, 135, 250, 1);
    }

    #msg-sound {
        -webkit-user-select: none !important;
        user-select: none !important;
    }

    .rprogress {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 140px;
        height: 140px;
        margin-left: -70px;
        margin-top: -70px;
        background-image: url(../images/arecord.png);
        background-repeat: no-repeat;
        background-position: center center;
        background-size: 30px 30px;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 5px;
        display: none;
        -webkit-transition: .15s;
    }

    .rschedule {
        background-color: rgba(0, 0, 0, 0);
        border: 5px solid rgba(0, 183, 229, 0.9);
        opacity: .9;
        border-left: 5px solid rgba(0, 0, 0, 0);
        border-right: 5px solid rgba(0, 0, 0, 0);
        border-radius: 50px;
        box-shadow: 0 0 15px #2187e7;
        width: 46px;
        height: 46px;
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -23px;
        margin-top: -23px;
        -webkit-animation: spin 1s infinite linear;
        animation: spin 1s infinite linear;
    }

    .r-sigh {
        display: none;
        border-radius: 50px;
        box-shadow: 0 0 15px #2187e7;
        width: 46px;
        height: 46px;
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -23px;
        margin-top: -23px;
        text-align: center;
        line-height: 46px;
        font-size: 40px;
        font-weight: bold;
        color: #2187e7;
    }

    .rprogress-sigh {
        background-image: none !important;
    }

    .rprogress-sigh .rschedule {
        display: none !important;
    }

    .rprogress-sigh .r-sigh {
        display: block !important;
    }

    .rsalert {
        font-size: 12px;
        color: #bbb;
        text-align: center;
        position: absolute;
        border-radius: 5px;
        width: 130px;
        margin: 5px 5px;
        padding: 5px;
        left: 0px;
        bottom: 0px;
    }

    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    #h {
        background: #fff;
        border: solid 1px #ddd;
        padding: 10px !important;
        font-size: 16px !important;
        font-family: verdana !important;
        line-height: 18px !important;
        overflow: visible;
        position: absolute;
        left: -1000px;
        right: 0px;
        word-break: break-all;
        word-wrap: break-word;
    }

    .cancel {
        background-color: darkred;
    }
    </style>
</head>

<body contextmenu="return false;">
    <header class="mui-bar mui-bar-nav">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 class="mui-title" id="title"></h1>
    </header>
    <pre id='h'></pre>
    <script id='msg-template' type="text/template">
        <% for(var i in record){ var item=record[i]; %>
            <div class="msg-item <%= (item.sender=='self'?' msg-item-self':'') %>" msg-type='<%=(item.type)%>' msg-content='<%=(item.content)%>'>
                <% if(item.sender=='self' ) { %>
                    <i class="msg-user mui-icon mui-icon-person"></i>
                    <% } else { %>
                        <!-- <img class="msg-user-img" src="../images/logo.png" alt="" /> -->
                        <i class="msg-user mui-icon mui-icon-person"></i>
                        <% } %>
                            <div class="msg-content">
                                <div class="msg-content-inner">
                                    <% if(item.type=='text' ) { %>
                                        <%=( item.content|| '&nbsp;&nbsp;') %>
                                            <% } else if(item.type=='image' ) { %>
                                                <img class="msg-content-image" src="<%=(item.content)%>" style="max-width: 100px;" />
                                                <% } else if(item.type=='sound' ) { %>
                                                    <span class="mui-icon" style="font-size: 18px;font-weight: bold;"></span>
                                                    <span class="play-state">点击播放</span>
                                                    <% } %>
                                </div>
                                <div class="msg-content-arrow"></div>
                            </div>
                            <div class="mui-item-clear"></div>
            </div>
            <% } %>
    </script>
    <div class="mui-content">
        <div id='msg-list'>
        </div>
    </div>
    <footer>
        <div class="footer-center">
            <textarea id='msg-text' type="text" class='input-text'></textarea>
        </div>
        <label for="" class="footer-right">
            <i id='msg-type' class="mui-icon">发送</i>
        </label>
    </footer>
    <script src="../../js/mui.min.js"></script>
    <script src="../../js/converse/strophe.min.js"></script>
    <script src="../../js/arttmpl.js"></script>
    <script type="text/javascript" charset="utf-8">
    var BOSH_SERVICE = 'http://112.74.209.204:7070/http-bind';
    var connection = null;
    connection = new Strophe.Connection(BOSH_SERVICE);
    var userJID;

    (function($, doc) {
        var MIN_SOUND_TIME = 800;
        $.init({
            gestureConfig: {
                tap: true, //默认为true
                doubletap: true, //默认为false
                longtap: true, //默认为false
                swipe: true, //默认为true
                drag: true, //默认为true
                hold: true, //默认为false，不监听
                release: true //默认为false，不监听
            }
        });
        template.config('escape', false);

        $.plusReady(function() {
            var ws = plus.webview.currentWebview();
            var toUserName = ws.user_name;
            document.getElementById('title').innerHTML = toUserName;

            var token = plus.storage.getItem("token");
            var user_name = plus.storage.getItem("user_name");
            mui.ajax(apiUrl.apiIm, {
                data: {
                    user_name: user_name,
                    token: token,
                },
                dataType: 'json',
                type: 'post',
                timeout: 10000,
                success: function(data) {
                    if (data.status == 0) {
                        var impasswd = data.impasswd;
                        userJID = data.imuser +'@112.74.209.204';
                        connection.connect(userJID, impasswd, onConnect);
                    }
                },
            });

            /**
             * 连接绑定方法
             * @param status
             */
            function onConnect(status) {
                if (status == Strophe.Status.CONNECTING) {
                    console.log('Strophe is connecting.');
                } else if (status == Strophe.Status.CONNFAIL) {
                    console.log('Strophe failed to connect.');
                    $('#connect').get(0).value = 'connect';
                } else if (status == Strophe.Status.DISCONNECTING) {
                    console.log('Strophe is disconnecting.');
                } else if (status == Strophe.Status.DISCONNECTED) {
                    console.log('Strophe is disconnected.');
                    $('#connect').get(0).value = 'connect';
                } else if (status == Strophe.Status.CONNECTED) {
                    console.log('Strophe is connected.');
                    console.log('ECHOBOT: Send a message to ' + connection.jid +
                        ' to talk to me.');
                    connection.addHandler(onMessage, null, 'message', null, null, null);
                    connection.send($pres().tree());
                }
            }

            /**
             * 获取消息时的方法
             * @param msg
             * @returns {Boolean}
             */
            function onMessage(msg) {
                var to = msg.getAttribute('to');
                var from = msg.getAttribute('from');
                var type = msg.getAttribute('type');
                var elems = msg.getElementsByTagName('body');
                var body;
                if (type == "chat" && elems.length > 0) {
                    body = elems[0];
                    console.log('ECHOBOT: I got a message from ' + from + ': ' +
                        Strophe.getText(body));
                    if(from.substr(0,from.indexOf('@')) == toUserName) {
                        record.push({
                            sender: 'zs',
                            type: 'text',
                            content: Strophe.getText(body)
                        });
                        bindMsgList();
                    }
                }

                if (type == "groupchat" && elems.length > 0) {
                    console.log = elems[0];
                    console.log('ECHOBOT: I got a message from ' + from + ': ' + Strophe.getText(body));
                }

                return true;
            }

            /**
             * 发信息
             * @param toId
             * @param fromId
             * @param msg
             */
            function sendMsg(toId, fromId, msg) {
                var reply = $msg({
                    to: toId,
                    from: fromId,
                    type: 'chat'
                }).cnode(Strophe.xmlElement('body', '', msg));
                connection.send(reply.tree());
                console.log('ECHOBOT: I sent ' + toId + ': ' + msg);
            }


            plus.webview.currentWebview().setStyle({
                softinputMode: "adjustResize"
            });



            var showKeyboard = function() {
                if ($.os.ios) {
                    var webView = plus.webview.currentWebview().nativeInstanceObject();
                    webView.plusCallMethod({
                        "setKeyboardDisplayRequiresUserAction": false
                    });
                } else {
                    var Context = plus.android.importClass("android.content.Context");
                    var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
                    var main = plus.android.runtimeMainActivity();
                    var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
                    imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
                    //var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
                    imm.showSoftInput(main.getWindow().getDecorView(), InputMethodManager.SHOW_IMPLICIT);
                    //alert("ll");
                }
            };
            var record = [];
            var ui = {
                body: doc.querySelector('body'),
                footer: doc.querySelector('footer'),
                footerRight: doc.querySelector('.footer-right'),
                btnMsgType: doc.querySelector('#msg-type'),
                boxMsgText: doc.querySelector('#msg-text'),
                btnMsgImage: doc.querySelector('#msg-image'),
                areaMsgList: doc.querySelector('#msg-list'),
                boxSoundAlert: doc.querySelector('#sound-alert'),
                h: doc.querySelector('#h'),
                content: doc.querySelector('.mui-content')
            };
            ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
            //alert(ui.boxMsgText.offsetWidth );
            var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;
			console.log(footerPadding);
    console.log(ui.footer.offsetHeight);
    console.log(ui.boxMsgText.offsetHeight);
            var bindMsgList = function() {
                //绑定数据:
                /*tp.bind({
                    template: 'msg-template',
                    element: 'msg-list',
                    model: record
                });*/
                ui.areaMsgList.innerHTML = template('msg-template', {
                    "record": record
                });
                var msgItems = ui.areaMsgList.querySelectorAll('.msg-item');

                ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
            };

            window.addEventListener('resize', function() {
                ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
            }, false);

            var send = function(msg) {
                record.push(msg);
                bindMsgList();
            };

            function msgTextFocus() {
                ui.boxMsgText.focus();
                setTimeout(function() {
                    ui.boxMsgText.focus();
                }, 150);
            }
            //解决长按“发送”按钮，导致键盘关闭的问题；
            ui.footerRight.addEventListener('touchstart', function(event) {
                if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
                    msgTextFocus();
                    event.preventDefault();
                }
            });
            //解决长按“发送”按钮，导致键盘关闭的问题；
            ui.footerRight.addEventListener('touchmove', function(event) {
                if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
                    msgTextFocus();
                    event.preventDefault();
                }
            });

            ui.footerRight.addEventListener('release', function(event) {
                if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
                    //showKeyboard();
                    ui.boxMsgText.focus();
                    setTimeout(function() {
                        ui.boxMsgText.focus();
                    }, 150);

                    sendMsg(toUserName+'@112.74.209.204', userJID, ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>'));
                    send({
                        sender: 'self',
                        type: 'text',
                        content: ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>')
                    });
                    ui.boxMsgText.value = '';
                    $.trigger(ui.boxMsgText, 'input', null);
                }
            }, false);

            var setSoundAlertVisable = function(show) {
                if (show) {
                    ui.boxSoundAlert.style.display = 'block';
                    ui.boxSoundAlert.style.opacity = 1;
                } else {
                    ui.boxSoundAlert.style.opacity = 0;
                    //fadeOut 完成再真正隐藏
                    setTimeout(function() {
                        ui.boxSoundAlert.style.display = 'none';
                    }, 200);
                }
            };
            var recordCancel = false;
            var recorder = null;
            var startTimestamp = null;
            var stopTimestamp = null;
            var stopTimer = null;

            ui.boxMsgText.addEventListener('input', function(event) {
                ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');
                ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');
                ui.h.innerText = ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '\n-') || '-';
                ui.footer.style.height = (ui.h.offsetHeight + footerPadding) + 'px';
                ui.content.style.paddingBottom = ui.footer.style.height;
            });
            var focus = false;
            ui.boxMsgText.addEventListener('tap', function(event) {
                ui.boxMsgText.focus();
                setTimeout(function() {
                    ui.boxMsgText.focus();
                }, 0);
                focus = true;
                setTimeout(function() {
                    focus = false;
                }, 1000);
                event.detail.gesture.preventDefault();
            }, false);
            //点击消息列表，关闭键盘
            ui.areaMsgList.addEventListener('click', function(event) {
                if (!focus) {
                    ui.boxMsgText.blur();
                }
            })
        });
    }(mui, document));
    </script>
</body>

</html>
