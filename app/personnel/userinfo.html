<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>个人资料</title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/custom.css" rel="stylesheet" />
		<style>
			body {
				background: #fff;
				font-size: 15px;
				color: #333;
			}
			
			ul {
				list-style: none;
				padding-left: 0;
				margin: 0;
			}
			
			.mui-bar-nav.mui-bar .mui-icon {
				width: 73px;
				height: 52px;
				top: 21px;
				display: flex;
				align-items: center;
			}
			
			.info {}
			
			.info .pedding_top {
				height: 20px;
				background: #f2f2f2;
				width: 100%;
			}
			
			.info ul li:after {
				width: 100%;
				height: 1px;
				content: '';
				display: block;
				padding: 0;
				position: relative;
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: #ccc;
			}
			
			.info .user_info {
				display: flex;
				position: relative;
				padding: 0 15px;
				height: 58px;
				align-items: center;
			}
			
			.info .user_info span {
				display: block;
			}
			
			.info .user_info a {
				position: absolute;
				top: 20px;
				right: 15px;
				width: 17px;
				height: 16px;
			}
			
			.info .user_info .modify {
				width: 17px;
				height: 16px;
			}
			
			.info .user_info>img {
				width: 38px;
				height: 38px;
				border-radius: 50px;
			}
			.info .user_info .header{
				display: inline-block;
				width: 38px;
				height: 38px;
				border-radius: 50px;
				background: url('../../public/img/user-header.png') no-repeat 2px -1px;
				background-size: 32px 32px;
			}
			.info .user_info div {
				padding: 0 10px;
			}
			
			.info span {
				/*display: inline-block;*/
				margin-right: 30px;
			}
			
			.info span:nth-child(1) {
				margin-bottom: 0px;
			}
			
			.infoDetails span {
				height: 36px;
				line-height: 36px;
			}
			
			.infoDetails span:nth-child(1) {
				padding-left: 15px;
			}
			
			.infoDetails ul li {
				display: block;
				align-items: center;
			}
			
			.infoDetails ul li span:nth-child(1) {
				width: 80px;
				text-align: right;
				color: #999;
			}
			
			.mui-content {
				background: white;
			}
			
			.back {
				display: block;
				width: 10px;
				height: 16px;
				background: url('../../public/img/back.png') no-repeat;
				background-size: 10px 16px;
				margin-left: 10px;
			}
			
			.mui-icon-back:before,
			.mui-icon-left-nav:before {
				content: '';
			}
			
			.btncontent {
				padding: 0 20px;
			}
			
			.management {
				width: 100%;
				height: 36px;
				line-height: 25px;
				border-radius: 0;
				background: #fb4847;
				border-radius: 4px;
				color: white;
				font-size: 15px;
				margin-top: 20px;
				margin-bottom: 20px;
				border: none;
			}
			
			.update {
				margin-bottom: 0;
				background: #3a89fb;
			}
			
			.update:active {
				background: #0b5fde;
			}
			
			button:enabled:active {
				background: red;
			}
			
			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body>
		<div id="app" v-cloak>
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left">
					<span class="back"></span>
				</a>
				<h1 class="mui-title">个人资料</h1>
			</header>
			<div class="mui-content">
				<div class="info">
					<div class="pedding_top"></div>
					<ul class="filter-ul">
						<li href="../personnel/userInfoModify.html" class="filter-li">
							<div class="user_info">
								<!--<img src="../../public/img/user-header.png" alt="" />-->
								<span class="header"></span>
								<div>
									<span>{{realname}}</span>
								</div>
								<a href="#">
									<img src="../../public/img/modify.png" alt="" class="modify" />
								</a>
							</div>
						</li>
					</ul>
					<div class="infoDetails">
						<ul>
							<li>
								<span>账&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;号</span>
								<span>{{currentUserName}}</span>
							</li>
							<li>
								<span>角&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;色</span>
								<span>{{rolename}}</span>
							</li>
							<li>
								<span>工&nbsp;&nbsp;作&nbsp;&nbsp;组 </span>
								<span>{{work_group}}</span>
							</li>
							<li>
								<span>电&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;话</span>
								<span>{{mobilephone}}</span>
							</li>
							<li>
								<span>公司号码</span>
								<span>{{officephone}}</span>
							</li>
							<li>
								<span>邮&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;箱</span>
								<span>{{email}}</span>
							</li>
						</ul>
						<div class="btncontent" v-show="currentAccount==='parentAccount'">
							<button class="management update" id="update">检查更新</button>
						</div>
						<div class="btncontent" v-show="currentAccount==='parentAccount'">
							<button class="management" id="logout">退出登录</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/url.js"></script>
		<script src="../../js/vue.min.js"></script>
		<script>
			var vm = new Vue({
				el: '#app',
				data: {
					loginData: '',
					name: '张三丰',
					group: '高手组',
					account: '653685',
					character: '小组组长',
					phone: '13800138000',
					email: '',
					organizationvalue: '0',
					signature: '',
					user_name: '',
					currentUserName: '',
					userData: '',
					additionalInfo: '',
					departInfo: '',
					currentAccount: '',
					deviceData: '',
					token: '',
					currentId: '',
					rolename: '',
					mobilephone: '',
					officephone: '',
					realname: '',
					work_group: '',
					username: '',
					local_version: '',
				},
				methods: {},
				created: function() {
					mui.plusReady(function() {
						mui.init({});
						vm.local_version = plus.runtime.version;
						vm.signature = plus.storage.getItem('signature');
						vm.user_name = plus.storage.getItem('user_name');
						vm.token = plus.storage.getItem('token');
						// 获取上层页面传递过来的参数
						var self = plus.webview.currentWebview();
						vm.currentAccount = self.currentAccount;
						vm.userId = self.userId;
						vm.username = self.username;
						var index = self.index;
						// 请求页面数据方法
						if(vm.currentAccount === 'parentAccount') {
							refreshUserInfo();
						} else if(vm.currentAccount === 'subAccount') {
							refreshSubUserInfo();
						}
						window.addEventListener('refreshUserInfo', function() {
							refreshUserInfo();
						});
						window.addEventListener('refreshSubUserInfo', function(event) {
							var index = event.detail.index;
							refreshSubUserInfo();
						});
						mui('.filter-ul').on('tap', '.filter-li', function(e) {
							var url = this.getAttribute('href');
							mui.openWindow({
								url: url,
								id: url,
								// 传递到下层页面的数据
								extras: {
									currentAccount: vm.currentAccount,
									realName: vm.realname,
									workGroup: vm.work_group,
									mobilePhone: vm.mobilephone,
									officephone: vm.officephone,
									email: vm.email,
									currentId: vm.currentId,
									index: index
								}
							});
						});

						function refreshUserInfo() {
							mui.ajax(apiUrl.stuff_lists, {
								data: {
									user_name: plus.storage.getItem('user_name'),
									token: plus.storage.getItem('token'),
									list_or_myself: 'self'
								},
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data) {
									if(data.status === 0&&data.recordList.length!==0) {
										vm.deviceData = data.recordList[0];
										vm.work_group = vm.deviceData.wrok_group !== 'undefined' ? vm.deviceData.wrok_group : '';
										vm.currentUserName = vm.deviceData.username;
										vm.realname = vm.deviceData.realname;
										vm.rolename = vm.deviceData.rolename;
										vm.mobilephone = vm.deviceData.mobilephone;
										vm.officephone = vm.deviceData.officephone !== 'undefined' ? vm.deviceData.officephone : '';
										vm.email = vm.deviceData.email !== 'undefined' ? vm.deviceData.email : '';
										vm.currentId = vm.deviceData.id;
									} else if(data.status === 40004) {
										mui.openWindow({
											url: '../../login.html',
											id: 'login'
										});
										setTimeout(function() {
											plus.nativeUI.closeWaiting();
											plus.webview.currentWebview().close('none');
										}, 500);
									} else {
										plus.nativeUI.toast(data.info);
										setTimeout(function() {
											plus.nativeUI.closeWaiting();
										}, 1000);
									}
								},
								error: function(xhr, type, errorThrown) {
									console.log(JSON.stringify(xhr))
									vm.hasResult = false;
									// 异常处理；
									onNetChange();
									plus.nativeUI.closeWaiting();
								}
							});
						}

						function refreshSubUserInfo() {
							mui.ajax(apiUrl.stuff_lists, {
								data: {
									user_name: vm.user_name,
									token: vm.token,
									num_per_page: 50
								},
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data) {
									if(data.status === 0) {
										var tempData = data.recordList;
										var tempArray;
										for(var i = 0; i < tempData.length; i++) {
											if(tempData[i].username === vm.username) {
												tempArray = tempData[i];
											}
										}
										vm.deviceData = tempArray;
										vm.work_group = vm.deviceData.wrok_group !== 'undefined' ? vm.deviceData.wrok_group : '';
										vm.currentUserName = vm.deviceData.username;
										vm.realname = vm.deviceData.realname;
										vm.rolename = vm.deviceData.rolename;
										vm.mobilephone = vm.deviceData.mobilephone;
										vm.officephone = vm.deviceData.officephone !== 'undefined' ? vm.deviceData.officephone : '';
										vm.email = vm.deviceData.email !== 'undefined' ? vm.deviceData.email : '';
										vm.currentId = vm.deviceData.id;
									} else if(data.status === 40004) {
										mui.openWindow({
											url: '../../login.html',
											id: 'login'
										});
										plus.nativeUI.closeWaiting();
									} else {
										plus.nativeUI.toast(data.info);
										setTimeout(function() {
											plus.nativeUI.closeWaiting();
										}, 1000);
									}
								},
								error: function(xhr, type, errorThrown) {
									// 异常处理；
									onNetChange();
									plus.nativeUI.closeWaiting();
								}
							});
						}
						document.getElementById('logout').addEventListener('tap', function() {
							mui.ajax(apiUrl.logout, {
								data: {
									user_name: vm.user_name,
									token: vm.token
								},
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data) {
									if(data.status === 0 || data.status === 40004) {
										mui.openWindow({
											url: '../../login.html',
											id: 'login'
										});
										var lauchFlag = plus.storage.getItem('lauchFlag');
										plus.storage.clear();
										plus.storage.setItem('lauchFlag', lauchFlag);
										setTimeout(function() {
											plus.webview.currentWebview().close('none');
										}, 500);
									}
								},
								error: function(xhr, type, errorThrown) {
									onNetChange();
								}
							});
						});

						document.getElementById('update').addEventListener('tap', function() {
							mui.ajax(apiUrl.latest_version, {
								data: {
									app_name: 'south_cloud_app',
									local_version: vm.local_version
								},
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data) {
									console.log(JSON.stringify(data))
									if(data.status === 0 && data.version !== '') {
										var version = data.version;
										mui.confirm(data.description, 'SouthCloud', ['取消', '更新'], function(e) {
											if(e.index === 1) {
												plus.runtime.openURL(apiUrl.download_app + '?app_name=south_cloud_app&version=' + version);
											}
										}, 'div');
									} else if(data.status === 40004) {
										mui.openWindow({
											url: '../../login.html',
											id: 'login'
										});
									} else {
										mui.alert('', '当前已是最新版本!', '确定', function(e) {}, 'div');
									}
								},
								error: function() {
									mui.toast('网络发生错误，请稍后再试！');
								}
							});
						});
					});
				}
			});
		</script>
	</body>

</html>