<!DOCTYPE html>
<html class="ui-page-login">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>位置</title>
	<link href="../../css/mui.min.css" rel="stylesheet" />
	<link href="../../css/custom.css" rel="stylesheet" />
	<link href="../../css/input.css" rel="stylesheet" />
	<link href="../../css/ol.css" rel="stylesheet" />
	<link href="../../css/ol3-layerswitcher.css" rel="stylesheet" />
	<link href="../../js/overlay/popupoverlay.css" rel="stylesheet">
	<link href="../../css/map.css" rel="stylesheet" />
	<script src="../js/jquery.js"></script>
	<style>
		body {
			background: #fff;
			font-size: 20px;
		}

		.mui-bar-nav.mui-bar .mui-icon {
			width: 73px;
			height: 52px;
			top: 21px;
			display: flex;
			align-items: center;
		}

		.popup-info {
			padding: 6px 6px 0 6px;
			text-align: left;
		}

		.popup-info p {
			color: #fff;
		}
		.back {
				display: block;
				width: 10px;
				height: 16px;
				background: url('../../public/img/back.png') no-repeat;
				background-size: 10px 16px;
				margin-left: 10px;
			}
			.mui-icon-back:before, .mui-icon-left-nav:before{
				content:'';
			}
	</style>
</head>

<body>
	<div id="app">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left">
				<span class="back"></span>
			</a>
			<h1 class="mui-title">位置</h1>
		</header>
		<div class="mui-content">
			<div class="s-map-wrap">
				<div style="height: 100%;" id="map" class="map"> </div>
			</div>
		</div>

		<!--右上角弹出菜单1-->
		<div id="topPopover1" class="mui-popover">
			<div class="mui-popover-arrow" style="left:130px"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" href="../personnel/userEntry.html">
							<a href="#">
								<img src="../../public/img/related.png" alt="" />
								<span>设备关联</span>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<!--右上角弹出菜单2-->
		<div id="topPopover2" class="mui-popover">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul>
						<li>
							<span class="group_title">工作组</span>
							<span class="group">白云组</span>
						</li>
						<li>
							<span class="group_title">机身号</span>
							<span class="group">5468456565465</span>
						</li>
						<li>
							<span class="group_title">状态</span>
							<div>
								<button class="active">在线</button>
								<button>离线</button>
							</div>

						</li>
						<li>
							<button>重置</button>
							<button class="active">完成</button>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<script src="../../js/ol.js"></script>
	<script src="../../js/ol3-layerswitcher.js"></script>
	<script src="../../js/overlay/popupoverlay.js"></script>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/url.js"></script>
	<script src="../../js/vue.min.js"></script>
	<script type="text/javascript">
		mui.plusReady(function () {
		  /* 初始化mui控件 */
		  mui.init({
		    beforeback: function () { }
		  });

		  plus.webview.currentWebview().setStyle({
		    softinputMode: 'adjustResize' // 弹出软键盘时自动改变webview的高度
		  });

		  var self = plus.webview.currentWebview();
		  var deviceInfo = self.item;

		  // 天地图加载资源
		  var tianDiTuMapLayer = new ol.layer.Tile({
		    title: '天地图路网',
		    preload: Infinity,
		    source: new ol.source.XYZ({
		      url: 'http://t4.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}'
		    })
		  });
		  var tianDiTuAnnotation = new ol.layer.Tile({
		    title: '天地图文字标注',
		    source: new ol.source.XYZ({
		      url: 'http://t3.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}'
		    })
		  });

		  // 设备在线样式
		  var pointOnlineStyle = new ol.style.Style({
		    image: new ol.style.Icon({
		      src: '../../public/img/device_online.png',
		      anchor: [0.5, 0.5] // 设置图标位置
		    })
		  });

		  // 设备离线样式
		  var pointOfflineStyle = new ol.style.Style({
		    image: new ol.style.Icon({
		      src: '../../public/img/device_offline.png',
		      anchor: [0.5, 0.5] // 设置图标位置
		    })
		  });

		  var pointLayers = new ol.layer.Vector({
		    source: new ol.source.Vector({
		      features: [new ol.Feature({
		        geometry: new ol.geom.Point([deviceInfo.longitude, deviceInfo.latitude])
		      })]
		    }),
		    style: function (feature, resolution) {
		      return deviceInfo.onlineStatus === 1 ? pointOnlineStyle : pointOfflineStyle;
		    }
		  });

		  // 比例尺控件
		  var scaleLineControl = new ol.control.ScaleLine();

		  /** * 调用外部的JS创建弹出框 */
		  var popup = new ol.Overlay.Popup({
		    popupClass: 'black', // "tooltips", "warning" "black" "default", "tips", "shadow",
		    closeBox: true,
		    positioning: 'auto',
		    autoPan: true,
		    autoPanAnimation: { duration: 250 }
		  });

		  var olMap = new ol.Map({
		    // 图层
		    layers: [
		      tianDiTuMapLayer, tianDiTuAnnotation, pointLayers
		    ],
		    overlays: [popup],
		    target: 'map',
		    // 禁止在移动端旋转设备
		    interactions: ol.interaction.defaults({ altShiftDragRotate: false, pinchRotate: false }),
		    controls: ol.control.defaults({
		      attributionOptions: ({
		        collapsible: false

		      }),
		      attribution: false,
		      // 不显示旋转控件
		      rotate: false,
		      // 不显示缩放控件
		      zoom: false
		    }).extend([
		      // 添加比例尺控制到地图上
		      scaleLineControl
		    ]),
		    view: new ol.View({
		      // 指定投影使用EPSG:4326
		      projection: 'EPSG:4326',
		      constrainRotation: false,
		      enableRotation: false,
		      center: [deviceInfo.longitude, deviceInfo.latitude],
		      zoom: 10,
		      minZoom: 0,
		      maxZoom: 24
		    })
		  });

		  olMap.on('singleclick', function (evt) {
		    if (evt.dragging) {
		      return;
		    }
		    var pixel = olMap.getEventPixel(evt.originalEvent);
		    var feature = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {
		      return feature;
		    });
		    if (feature === null || feature === undefined) return;
		    displayDeviceInfoOverlay();
		  }, pointLayers);

		  function displayDeviceInfoOverlay(selectFeature) {
		    popup.hide();
		    var content = '<div class="popup-info">';
		    content += '<p>设备编号:' + deviceInfo.identifyCode + '</p>';
		    if (deviceInfo.onlineStatus === 1) {
		      content += '<p>连接时间:' + timeTrans(deviceInfo.connectTime, 'yyyy-MM-dd HH:mm:ss') + '</p>';
		    } else {
		      content += '<p>断开时间:' + timeTrans(deviceInfo.disconnectTime, 'yyyy-MM-dd HH:mm:ss') + '</p>';
		    }
		    var upDataUserName = deviceInfo.upDataUserName ? deviceInfo.upDataUserName : '-';
		    var upDataCompanyInfo = deviceInfo.upDataCompanyInfo ? deviceInfo.upDataCompanyInfo : '-';
		    content += '<p>经度:' + formatDegree(deviceInfo.longitude) + '</p>';
		    content += '<p>纬度:' + formatDegree(deviceInfo.latitude) + '</p>';
		    content += '<p>用户名:' + upDataUserName + '</p>';
		    content += '<p>用户单位:' + upDataCompanyInfo + '</p></div>';
		    popup.show([deviceInfo.longitude, deviceInfo.latitude], content);
		  }
		});
	</script>
</body>

</html>