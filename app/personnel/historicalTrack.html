<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>实时轨迹</title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/custom.css" rel="stylesheet" />
		<!--<link href="../../css/input.css" rel="stylesheet" />-->
		<link href="../../css/ol.css" rel="stylesheet" />
		<link href="../../css/ol3-layerswitcher.css" rel="stylesheet" />
		<link href="../../css/map.css" rel="stylesheet" />
		<script src="../js/jquery.js"></script>
		<style>
			body {
				background: #fff;
				font-size: 20px;
			}

			ul {
				list-style: none;
				padding-left: 10px;
				padding-right: 10px;
				font-size: 16px;
				margin-top: 10px;
			}

			ul li {
				margin-bottom: 10px;
			}

			ul li:nth-child(2) span {
				display: inline-block;
				width: 50%;
			}

			ul li:nth-child(3) span {
				display: inline-block;
				width: 49%;
			}

			ul li:nth-child(1) span {
				display: inline-block;
			}

			ul li:nth-child(4) a {
				background: #409eff;
				color: white;
				width: 100px;
				font-size: 18px;
				position: relative;
				top: -3px;
				text-align: center;
				line-height: 36px;
				border-radius: 5px;
			}

			.mui-bar-nav.mui-bar .mui-icon {
				width: 73px;
				height: 73px;
				display: flex;
				align-items: center;
			}

			.dropDown {
				width: 100%;
				height: 200px;
				position: fixed;
				background: white;
				z-index: 1;
				bottom: 0;
				left: 0;
				border: 1px solid #ddd;
				-webkit-transform: translateY(0px);
				-webkit-transition: 0.38s;
			}

			.active {
				-webkit-transform: translateY(200px);
				-webkit-transition: 0.38s;
			}

			.dropDown a {
				display: block;
				width: 70px;
				height: 34px;
				background: white;
				border-top-left-radius: 5px;
				border-top-right-radius: 5px;
				position: absolute;
				left: 50%;
				top: -34px;
				-webkit-transform: translate(-50%);
				border: 1px solid #ddd;
				border-bottom: none;
			}

			.dropDown a span {
				display: block;
				width: 50px;
				height: 1px;
				background: #ddd;
				position: absolute;
				top: 10px;
				left: 10px;
			}

			.dropDown a span:nth-child(2) {
				top: 20px;
			}

			.dropDown .btn-content {
				padding-top: 10px;
				padding-left: 10px;
				height: 50px;
			}

			.dropDown .btn-content button {
				margin-right: 5px;
				width: 80px;
				background: #999;
				color: white;
				font-size: 18px;
				padding: 4px 12px;
			}

			.dropDown .btn-content .changecolor {
				background: #409eff;
			}

			.date {
				display: inline-block;
				text-align: center;
				width: 116px;
				border: 1px solid #999;
				padding: 0px;
				position: relative;
			}

			.date img {
				width: 12px;
				height: 12px;
				position: absolute;
				top: 5px;
				right: 3px;
			}

			.Num {
				width: 49%;
			}

			#pickDateBtn {
				width: 120px;
				height: 20px;
				line-height: 4px;
				position: absolute;
				top: -5px;
				left: -1px;
				margin: 0;
				opacity: 0;
			}

			.s-map-wrap {
				padding-top: 73px;
			}

			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body>
		<div id="app">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">历史轨迹</h1>
			</header>
			<div class="mui-content">
				<div class="s-map-wrap">
					<div class="dropDown" :class="{active:isActive}">
						<div class="btn-content" v-cloak>
							<button v-for="(item,index) in modetype" v-on:tap="changeMode(index)" :class="{changecolor:index===mode}">{{item.name}}</button>
						</div>
						<ul v-show="mode===0">
							<li v-cloak>
								<span class="Num">{{currentIndexUserName}}</span>
								<span>日期：
									<span class="date" id="info">{{date}}
										<img src="../../public/img/down.png" alt="" class="down" />
										<button id='pickDateBtn' type="button" class="mui-btn mui-btn-block">选择日期</button>
									</span>
								</span>

							</li>
							<li v-cloak><span>{{currentCompanyInfo}}</span><span>{{currentIndexUserName}}</span></li>
							<li v-cloak><span>在线时长:{{currentDayOnlineTime}}</span>
								<span>作业里程:暂无数据</span>
							</li>
						</ul>
						<ul v-show="mode===1">
							<li><span>时间：2018年4月10日 12:23:56</span></li>
							<li><span>状态：固定解</span></li>
							<li><span>工作模式:移动站</span><span>数据链:内置电台</span></li>
							<li>
								<a href="coordinateDetails.html">查看详情</a>
							</li>
						</ul>
						<a v-on:tap="changestatus">
							<span></span>
							<span></span>
						</a>
					</div>
					<div style="height: 100%;" id="map" class="map"> </div>
				</div>
			</div>
		</div>
		<script src="../../js/ol.js"></script>
		<script src="../../js/ol3-layerswitcher.js"></script>
		<script src="../js/rtkmap.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/url.js"></script>
		<script src="../../js/vue.min.js"></script>
		<script>
			var vm = new Vue({
			  el: '#app',
			  data: {
			    user_name: '',
			    token: '',
			    isActive: false,
			    mode: 0,
			    date: '请选择日期',
			    currentData: '',
			    currentIndex: '',
			    currentIndexUserName: '',
			    currentCompanyInfo: '',
			    currentIdentifyCode: '',
			    currenttrackDayId: '',
			    currentDayOnlineTime: '',
			    currentCoordinatePoints: [],
			    currentGeojsonObject: {
			      'type': 'FeatureCollection',
			      'crs': {
			        'type': 'name',
			        'properties': {
			          'name': 'EPSG:4326'
			        }
			      },
			      'features': [{
			        'type': 'Feature',
			        'geometry': {
			          'type': 'GeometryCollection',
			          'geometries': [{
			            'type': 'LineString',
			            'coordinates': []
			          }]
			        }
			      }]
			    },
			    trackData: '',
			    currentDate: '',
			    modetype: [{
			      name: '轨迹'
			    }, {
			      name: '坐标点'
			    }]
			  },
			  methods: {
			    changestatus: function () {
			      vm.isActive = !vm.isActive;
			    },
			    changeMode: function (index) {
			      this.mode = index;
			    }
			  },
			  created: function () {}
			});
			mui.init({
			  beforeback: function () {}
			});
			mui.plusReady(function () {
			  // 获取上层页面传递过来的参数
			  var self = plus.webview.currentWebview();
			  vm.currentIndexUserName = self.upDataUserName;
			  vm.currentCompanyInfo = self.upDataCompanyInfo;
			  vm.currentIdentifyCode = self.identifyCode;
			  vm.currenttrackDayId = self.track_day_id;
			  // 登陆时存放到本地的数据
			  vm.token = plus.storage.getItem('token');
			  vm.user_name = plus.storage.getItem('user_name');
			  // 请求指定设备的历史跟踪轨迹数据
			  mui.ajax(apiUrl.track_info_page, {
			    data: {
			      user_name: vm.user_name,
			      token: vm.token,
			      filter_identifycode: vm.currentIdentifyCode
			    },
			    dataType: 'json',
			    type: 'post',
			    timeout: 10000,
			    success: function (data) {
			      if (data.status === 0) {
			        vm.trackData = data.recordList;
			      } else {
			        plus.nativeUI.toast(data.info);
			        setTimeout(function () {
			          plus.nativeUI.closeWaiting();
			        }, 1000);
			      }
			    },
			    error: function (xhr, type, errorThrown) {
			      // 异常处理；
			      onNetChange();
			      plus.nativeUI.closeWaiting();
			    }
			  });
			});

			// 日期控件
			document.getElementById('pickDateBtn').addEventListener('tap', function () {
			  var dDate = new Date();
			  // dDate.setFullYear(2014, 7, 16);
			  var minDate = new Date();
			  minDate.setFullYear(2010, 0, 1);
			  var maxDate = new Date();
			  maxDate.setFullYear(2018, 11, 31);
			  plus.nativeUI.pickDate(function (e) {
			    // 如果月份小于10，显示时前面+‘0’
			    var d = e.date;
			    if (d.getMonth() >= 9) {
			      if (d.getDate() >= 9) {
			        vm.date = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
			      } else {
			        vm.date = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + '0' + d.getDate();
			      }
			    } else {
			      if (d.getDate() >= 9) {
			        vm.date = d.getFullYear() + '-' + '0' + (d.getMonth() + 1) + '-' + d.getDate();
			      } else {
			        vm.date = d.getFullYear() + '-' + '0' + (d.getMonth() + 1) + '-' + '0' + d.getDate();
			      }
			    }

			    for (var i = 0; i < vm.trackData.length; i++) {
			      // 如果该设备在被选中的日期中有历史轨迹数据存在
			      if (vm.trackData[i].trackDate.indexOf(vm.date) !== -1) {
			        vm.currentDate = vm.trackData[i].id;
			        // console.log(vm.currentDate)
			        // 转换在线总时长的展示方式
			        changeTimeFormat(vm.trackData[i].dayOnlineSeconds);
			        // 当选择日期后，发送请求该日期的全部轨迹点数据
			        console.log('开始请求数据');
			        mui.ajax(apiUrl.track_day_page, {
			          data: {
			            user_name: vm.user_name,
			            token: vm.token,
			            track_day_id: vm.currentDate,
			            num_per_page: 100
			          },
			          dataType: 'json',
			          type: 'post',
			          timeout: 10000,
			          success: function (data) {
			            if (data.status === 0) {
			              console.log('开始处理数据');
			              // console.log(JSON.stringify(data));
			              var tempTrackData = data.recordList;
			              var temp1 = [],
			                temp2 = [];
			              var tempPointData = [];

			              for (var i = 0; i < tempTrackData.length; i++) {
			                temp1.push(tempTrackData[i].longitude);
			                temp1.push(tempTrackData[i].latitude);
			                temp2.push(temp1);
			                temp1 = [];
			              }
							vm.currentCoordinatePoints = temp2;

			              for (var i = 0; i < vm.currentCoordinatePoints.length; i++) {
			                // 循环赋值对象必须在循环内声明，否则在外部时由于一直引用同一个对象导致只会输出循环最后的值
			                var tempPoint = {
			                  'type': 'Feature',
			                  'geometry': {
			                    'type': 'Point',
			                    'coordinates': []
			                  }
			                };
			                tempPoint.geometry.coordinates = vm.currentCoordinatePoints[i];
			                tempPointData.push(tempPoint);
			              }
			              // console.log(JSON.stringify(tempPointData));

			              var tempgeojsonObject = {
			                'type': 'FeatureCollection',
			                'crs': {
			                  'type': 'name',
			                  'properties': {
			                    'name': 'EPSG:4326'
			                  }
			                },
			                'features': [{
			                  'type': 'Feature',
			                  'geometry': {
			                    'type': 'GeometryCollection',
			                    'geometries': [{
			                      'type': 'LineString',
			                      'coordinates': []
			                    }]
			                  }
			                }]
			              };
			              // console.log(JSON.stringify(tempgeojsonObject.features[0].geometry.geometries[0].coordinates))
			              tempgeojsonObject.features[0].geometry.geometries[0].coordinates = vm.currentCoordinatePoints;

			              for (var i = 0; i < tempPointData.length; i++) {
			                tempgeojsonObject.features.push(tempPointData[i]);
			              }
			              // console.log(JSON.stringify(tempgeojsonObject));
			              vm.currentGeojsonObject = tempgeojsonObject;
			              // console.log(JSON.stringify(vm.currentGeojsonObject))
			              coordinateShow(vm.currentGeojsonObject);
			            } else {
			              plus.nativeUI.toast(data.info);
			              setTimeout(function () {
			                plus.nativeUI.closeWaiting();
			              }, 1000);
			            }
			          },
			          error: function (xhr, type, errorThrown) {
			            // 异常处理；
			            onNetChange();
			            plus.nativeUI.closeWaiting();
			          }
			        });
			        return;
			      }
			//如果该设备在被选中的日期中没有历史轨迹数据存在
			if (vm.trackData[i].trackDate.indexOf(vm.date) === -1) {
			        vm.currentDayOnlineTime = '没有在线';
			        vm.currentGeojsonObject = {
			          'type': 'FeatureCollection',
			          'crs': {
			            'type': 'name',
			            'properties': {
			              'name': 'EPSG:4326'
			            }
			          },
			          'features': [{
			            'type': 'Feature',
			            'geometry': {
			              'type': 'GeometryCollection',
			              'geometries': [{
			                'type': 'LineString',
			                'coordinates': []
			              }]
			            }
			          }]
			        };
			      }
			    }
			  }, function (e) {}, {
			    title: '请选择日期',
			    date: dDate,
			    minDate: minDate,
			    maxDate: maxDate
			  });
			});
			// ***********************************地图坐标数据(点、线)渲染模块******************************************
			function coordinateShow(data) {
			  console.log(JSON.stringify(data));
			  console.log('开始执行');
			  // 定义‘点’的通用样式
			  var image = new ol.style.Circle({
			    radius: 5,
			    fill: new ol.style.Fill({
			      color: 'rgba(0, 0, 255, .5)'
			    })
			  });
			  // 设置点、线的样式，并引用通用样式类
			  var styles = {
			    'Point': new ol.style.Style({
			      image: image
			    }),
			    'GeometryCollection': [new ol.style.Style({
			      stroke: new ol.style.Stroke({
			        color: 'magenta',
			        width: 1
			      }),
			      fill: new ol.style.Fill({
			        color: 'magenta'
			      })
			    })]
			  };

			  var styleFunction = function (feature, resolution) {
			    return styles[feature.getGeometry().getType()];
			  };

			  // 渲染的数据来源
			  var geojsonObject = data;
			  console.log(JSON.stringify(geojsonObject));
			  console.log('执行中11.....');
			  // 设置数据来源
			  var vectorSource = new ol.source.Vector({
			    features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
			  });
			  // 引用设置的数据
			  vectorLayer = new ol.layer.Vector({
			    source: vectorSource,
			    style: styleFunction
			  });

			  console.log('执行中22.....');
			  // 挂载到页面dom上
			  new ol.Map({
			    layers: [
			      new ol.layer.Tile({
			        source: new ol.source.OSM()
			      }),
			      vectorLayer
			    ],
			    view: new ol.View({
			      // 设置地图限制范围
			      // extent: [102, 29, 104, 31],
			      // 设置地图中心
			      center: [113.416, 23.18],
			      projection: 'EPSG:4326',
			      zoom: 14
			    }),
			    target: 'map',
			    controls: ol.control.defaults({
			      attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
			        collapsible: false
			      })
			    })
			  });
			}

			// 将在线总时长的秒数展示数据方式转换为时分秒
			function changeTimeFormat(dayOnlineSeconds) {
			  if (dayOnlineSeconds < 60) {
			    return (vm.currentDayOnlineTime = '0分' + dayOnlineSeconds + '秒');
			  }
	if (dayOnlineSeconds < 3600) {
			    return (vm.currentDayOnlineTime = Math.floor(dayOnlineSeconds / 60) + '分' + (dayOnlineSeconds - Math.floor(dayOnlineSeconds / 60) * 60) + '秒');
			  }
	if (dayOnlineSeconds <= 86400) {
			    return (vm.currentDayOnlineTime = Math.floor(dayOnlineSeconds / 3600) + '小时' + Math.floor((dayOnlineSeconds - Math.floor(dayOnlineSeconds / 3600) * 3600) / 60) + '分');
			  }
}
		</script>
	</body>

</html>