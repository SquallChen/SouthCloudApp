<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>实时轨迹</title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/custom.css" rel="stylesheet" />
		<!--<link href="../../css/input.css" rel="stylesheet" />-->
		<link href="../../css/ol.css" rel="stylesheet" />
		<link href="../../css/ol3-layerswitcher.css" rel="stylesheet" />
		<link href="../../css/map.css" rel="stylesheet" />
		<script src="../js/jquery.js"></script>
		<style>
			body {
				background: #fff;
				font-size: 20px;
			}
			
			ul {
				list-style: none;
				padding-left: 10px;
				padding-right: 10px;
				font-size: 16px;
				margin-top: 10px;
			}
			
			ul li {
				margin-bottom: 10px;
			}
			
			ul li:nth-child(2) span {
				display: inline-block;
				width: 50%;
			}
			
			ul li:nth-child(3) span {
				display: inline-block;
				width: 49%;
			}
			
			ul li:nth-child(1) span {
				display: inline-block;
			}
			
			ul li:nth-child(4) a {
				background: #409eff;
				color: white;
				width: 100px;
				font-size: 18px;
				position: relative;
				top: -3px;
				text-align: center;
				line-height: 36px;
				border-radius: 5px;
			}
			
			.mui-bar-nav.mui-bar .mui-icon {
				width: 73px;
				height: 73px;
				display: flex;
				align-items: center;
			}
			
			.dropDown {
				width: 100%;
				height: 200px;
				position: fixed;
				background: white;
				z-index: 1;
				bottom: 0;
				left: 0;
				border: 1px solid #ddd;
				-webkit-transform: translateY(0px);
				-webkit-transition: 0.38s;
			}
			
			.active {
				-webkit-transform: translateY(200px);
				-webkit-transition: 0.38s;
			}
			
			.dropDown a {
				display: block;
				width: 70px;
				height: 34px;
				background: white;
				border-top-left-radius: 5px;
				border-top-right-radius: 5px;
				position: absolute;
				left: 50%;
				top: -34px;
				-webkit-transform: translate(-50%);
				border: 1px solid #ddd;
				border-bottom: none;
			}
			
			.dropDown a span {
				display: block;
				width: 50px;
				height: 1px;
				background: #ddd;
				position: absolute;
				top: 10px;
				left: 10px;
			}
			
			.dropDown a span:nth-child(2) {
				top: 20px;
			}
			
			.dropDown .btn-content {
				padding-top: 10px;
				padding-left: 10px;
				height: 50px;
			}
			
			.dropDown .btn-content button {
				margin-right: 5px;
				width: 80px;
				background: #999;
				color: white;
				font-size: 18px;
				padding: 4px 12px;
			}
			
			.dropDown .btn-content .changecolor {
				background: #409eff;
			}
			
			.date {
				display: inline-block;
				text-align: center;
				width: 116px;
				border: 1px solid #999;
				padding: 0px;
				position: relative;
			}
			
			.date img {
				width: 12px;
				height: 12px;
				position: absolute;
				top: 5px;
				right: 3px;
			}
			
			.Num {
				width: 49%;
			}
			
			#pickDateBtn {
				width: 120px;
				height: 20px;
				line-height: 4px;
				position: absolute;
				top: -5px;
				left: -1px;
				margin: 0;
				opacity: 0;
			}
			
			.s-map-wrap {
				padding-top: 73px;
			}
			
			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body>
		<div id="app">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">历史轨迹</h1>
			</header>
			<div class="mui-content">
				<div class="s-map-wrap">
					<div class="dropDown" :class="{active:isActive}">
						<div class="btn-content" v-cloak>
							<button v-for="(item,index) in modetype" v-on:tap="changeMode(index)" :class="{changecolor:index===mode}">{{item.name}}</button>
						</div>
						<ul v-show="mode===0">
							<li v-cloak>
								<span class="Num">{{currentIndexUserName}}</span>
								<span>日期：
									<span class="date" id="info">{{date}}
										<img src="../../public/img/down.png" alt="" class="down" />
										<button id='pickDateBtn' type="button" class="mui-btn mui-btn-block">选择日期</button>
									</span>
								</span>

							</li>
							<li v-cloak><span>{{currentCompanyInfo}}</span><span>{{currentIndexUserName}}</span></li>
							<li v-cloak><span>在线时长:{{currentDayOnlineTime}}</span>
								<span>作业里程:暂无数据</span>
							</li>
						</ul>
						<ul v-show="mode===1">
							<li><span>时间：2018年4月10日 12:23:56</span></li>
							<li><span>状态：固定解</span></li>
							<li><span>工作模式:移动站</span><span>数据链:内置电台</span></li>
							<li>
								<a href="coordinateDetails.html">查看详情</a>
							</li>
						</ul>
						<a v-on:tap="changestatus">
							<span></span>
							<span></span>
						</a>
					</div>
					<div style="height: 100%;" id="map" class="map"> </div>
				</div>
			</div>
		</div>
		<!--<script src="../../js/datetimepicker/datetimepicker.min.js"></script>-->
		<script src="../../js/ol.js"></script>
		<script src="../../js/ol3-layerswitcher.js"></script>
		<script src="../js/rtkmap.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/url.js"></script>
		<script src="../../js/vue.min.js"></script>
		<script>
			var vm = new Vue({
				el: '#app',
				data: {
					user_name: '',
					token: '',
					isActive: false,
					mode: 0,
					date: '请选择日期',
					currentData: '',
					currentIndex: '',
					currentIndexUserName: '',
					currentCompanyInfo: '',
					currentIdentifyCode: '',
					currenttrackDayId: '',
					currentDayOnlineTime: '',
					trackData: '',
					currentDate: '',
					modetype: [{
						name: '轨迹'
					}, {
						name: '坐标点'
					}]
				},
				methods: {
					changestatus: function() {
						vm.isActive = !vm.isActive;
					},
					changeMode: function(index) {
						this.mode = index;
					}
				},
				created: function() {}
			});
			mui.init({
				beforeback: function() {}
			});
			mui.plusReady(function() {
				// 获取上层页面传递过来的参数
				var self = plus.webview.currentWebview();
				vm.currentIndexUserName = self.upDataUserName;
				vm.currentCompanyInfo = self.upDataCompanyInfo;
				vm.currentIdentifyCode = self.identifyCode;
				vm.currenttrackDayId = self.track_day_id;
				// 登陆时存放到本地的数据
				vm.token = plus.storage.getItem('token');
				vm.user_name = plus.storage.getItem('user_name');
				//请求指定设备的历史跟踪轨迹数据
				mui.ajax(apiUrl.track_info_page, {
					data: {
						user_name: vm.user_name,
						token: vm.token,
						filter_identifycode: vm.currentIdentifyCode,
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					success: function(data) {
						if(data.status === 0) {
							vm.trackData = data.recordList;
						} else {
							plus.nativeUI.toast(data.info);
							setTimeout(function() {
								plus.nativeUI.closeWaiting();
							}, 1000);
						}
					},
					error: function(xhr, type, errorThrown) {
						// 异常处理；
						onNetChange();
						plus.nativeUI.closeWaiting();
					}
				});
			});

			// 日期控件
			document.getElementById('pickDateBtn').addEventListener('tap', function() {
				var dDate = new Date();
				// dDate.setFullYear(2014, 7, 16);
				var minDate = new Date();
				minDate.setFullYear(2010, 0, 1);
				var maxDate = new Date();
				maxDate.setFullYear(2018, 11, 31);
				plus.nativeUI.pickDate(function(e) {
					//如果月份小于10，显示时前面+‘0’
					var d = e.date;
					if(d.getMonth() >= 9) {
						if(d.getDate() >= 9) {
							vm.date = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
						} else {
							vm.date = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + '0' + d.getDate();
						}
					} else {
						if(d.getDate() >= 9) {
							vm.date = d.getFullYear() + '-' + '0' + (d.getMonth() + 1) + '-' + d.getDate();
						} else {
							vm.date = d.getFullYear() + '-' + '0' + (d.getMonth() + 1) + '-' + '0' + d.getDate();
						}
					}

					for(var i = 0; i < vm.trackData.length; i++) {
						//如果该设备在被选中的日期中有历史轨迹数据存在 
						if(vm.trackData[i].trackDate.indexOf(vm.date) !== -1) {
							vm.currentDate = vm.trackData[i].id;
							//console.log(vm.currentDate)
							//转换在线总时长的展示方式
							changeTimeFormat(vm.trackData[i].dayOnlineSeconds);
							//当选择日期后，发送请求该日期的全部轨迹点数据
							mui.ajax(apiUrl.track_day_page, {
								data: {
									user_name: vm.user_name,
									token: vm.token,
									track_day_id: vm.currentDate,
								},
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data) {
									if(data.status === 0) {
										//console.log(JSON.stringify(data));
									} else {
										plus.nativeUI.toast(data.info);
										setTimeout(function() {
											plus.nativeUI.closeWaiting();
										}, 1000);
									}
								},
								error: function(xhr, type, errorThrown) {
									// 异常处理；
									onNetChange();
									plus.nativeUI.closeWaiting();
								}
							});
							return;
						};
						//如果该设备在被选中的日期中没有历史轨迹数据存在 
						if(vm.trackData[i].trackDate.indexOf(vm.date) === -1) {
							vm.currentDayOnlineTime = '没有在线'
						}
					}
				}, function(e) {}, {
					title: '请选择日期',
					date: dDate,
					minDate: minDate,
					maxDate: maxDate
				});
			});

			var map; // 地图变量
			var L = 110.017334; // 经度
			var B = 35.29936; // 纬度
			var Z = 4; // 缩放级别
			var Zoom = 18; // 最大缩放级别
			var raster2Url = 'http://t{0-7}.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}'; /* 地图图层url服务*/
			var layersUrl1 = 'http://t{0-7}.tianditu.com/DataServer?T=img_w&x={x}&y={y}&l={z}';
			var layersUrl2 = 'http://t{0-7}.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}';

			var raster2 = new ol.layer.Tile({
				source: new ol.source.XYZ({
					url: raster2Url
				})
			}); // 创建文字标注图层
			var layers = new ol.layer.Group({
				'title': '选择图层',
				layers: [
					new ol.layer.Tile({
						title: '卫星影像',
						type: 'base',
						visible: false,
						source: new ol.source.XYZ({
							url: layersUrl1
						})
					}),
					new ol.layer.Tile({
						title: '地图',
						type: 'base',
						visible: true,
						source: new ol.source.XYZ({
							url: layersUrl2
						})
					})
				]
			}); // 创建图层组使用图层控件实现可以切换图层

			var arr = [layers, raster2]; // 图层名称数组，初始化地图时加载
			/**
			 * [LoadMap ：实例化并加载地图]
			 * @param  L :经度
			 * @param  B :纬度
			 * @param  Z :中心级别
			 */
			LoadMap(L, B, Z, Zoom);

			function LoadMap(L, B, Z, Zoom) {
				map = new ol.Map({
					layers: arr,
					target: document.getElementById('map'),
					view: new ol.View({
						projection: 'EPSG:4326',
						/* extent: [70, 18, 135, 51],*/
						center: [L, B],
						zoom: Z,
						minZoom: Z,
						maxZoom: Zoom
					})
				});
			}

			/* map.addControl(new ol.control.ZoomSlider({})); //缩放下拉条*/
			map.addControl(new ol.control.ScaleLine()); // 比例尺控件
			/* map.addControl(new ol.control.FullScreen());//全屏控件*/

			var layerSwitcher = new ol.control.LayerSwitcher({
				tipLabel: 'Légende'
			});
			map.addControl(layerSwitcher); // 自定义选择图层控件
			/* 添加悬窗*/
			/* var viewport = map.getViewport();
      		$(viewport).append('<div id="share" class="share"></div>');*/

			//将在线总时长的秒数展示数据方式转换为时分秒
			function changeTimeFormat(dayOnlineSeconds) {
				if(dayOnlineSeconds < 60) {
					return(vm.currentDayOnlineTime = '0分' + dayOnlineSeconds + '秒');
				};
				if(dayOnlineSeconds < 3600) {
					return(vm.currentDayOnlineTime = Math.floor(dayOnlineSeconds / 60) + '分' + (dayOnlineSeconds - Math.floor(dayOnlineSeconds / 60) * 60) + '秒');
				};
				if(dayOnlineSeconds <= 86400) {
					return(vm.currentDayOnlineTime = Math.floor(dayOnlineSeconds / 3600) + '小时' + Math.floor((dayOnlineSeconds - Math.floor(dayOnlineSeconds / 3600) * 3600) / 60) + '分');
				};
			}

		</script>
	</body>

</html>