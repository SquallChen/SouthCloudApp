<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>南方云</title>
  <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="stylesheet" href="../../css/mui.min.css">
  <link rel="stylesheet" href="../../css/list.css">
  <style type="text/css">
    [v-cloak] {
      display: none;
    }

    .mui-row mui-slider-handle {
      margin-top: 8px;
    }

    .rtk-li {
      height: 72px;
    }

    .rtk-li-1 {
      height: 18px;
      line-height: 18px;
      padding: 0;
      margin: 6px 0 6px 0;
      font-size: 18px;
      color: #333;
    }


    .rtk-li-2 {
      display: inline-block;
      height: 16px;
      line-height: 16px;
      font-size: 14px;
      color: #999;
    }

    .mui-table-view-cell>.mui-slider-right>.mui-btn {
      font-size: 15px;
    }
  </style>
</head>

<body>
  <div id="app" v-cloak>
    <div id="pullrefresh" class="mui-content mui-scroll-wrapper">
      <div class="mui-scroll">
        <!--数据列表-->
        <div class="mui-table-view">
          <div class="mui-table-view-cell rtk-li" v-for="v in list" :id="v.id">
            <div class="mui-row mui-slider-handle">
              <div class="rtk-li-1">
                <span> {{ v.fileName }}</span>
              </div>
              <div class="rtk-li-2">
                <span>{{v.createDate | getTime}}</span>
              </div>
            </div>
            <div class="mui-slider-right mui-disabled">
              <button class="mui-btn mui-btn-red" @click="del(v.id)">删除</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="../../js/mui.min.js"></script>
  <script src="../../js/url.js"></script>
  <script src="../../js/vue.min.js"></script>
  <script>
    var vm = new Vue({
      el: '#app',
      data: {
        user_name: '',
        token: '',
        parent_id: '',
        list: []
      },
      methods: {
        del: function (id) {
          var dom = document.getElementById(id);
          mui.swipeoutClose(dom);
          var btnArray1 = ['否', '是'];
          mui.confirm('删除选中数据？ ', 'South', btnArray1, function (e) {
            if (e.index === 1) {
              mui.ajax(apiUrl.delete_files, {
                data: {
                  user_name: vm.user_name,
                  token: vm.token,
                  files_id: id
                },
                dataType: 'json',
                type: 'post',
                timeout: 10000,
                success: function (data) {
                  if (data.status === 0) {
                    mui.toast('删除成功！');
                    dom.parentNode.removeChild(dom);
                  } else {
                    mui.toast(data.info);
                  }
                }
              });
            }
          }, 'div');
        }
      },
      created: function () {
        mui.plusReady(function () {
          mui.init({
            pullRefresh: {
              container: '#pullrefresh',
              up: {
                contentrefresh: '正在加载...',
                callback: pullupRefresh,
                auto: false // 可选,默认false.自动上拉加载一次
              },
              down: {
                callback: pulldownRefresh
              }
            }
          });

          vm.user_name = plus.storage.getItem('user_name');
          vm.token = plus.storage.getItem('token');
          vm.parent_id = plus.storage.getItem('parent_id');
          getData(vm.parent_id);
        });
      },

      filters: {
        getTime: function (value) {
          if (!value) return '';
          return timeTrans(value, 'yyyy-MM-dd HH:mm:ss');
        }
      }
    });

    var page = 0;
    var comArray = ['确认'];

    /**
     * 下拉刷新具体业务实现
     */
    function pulldownRefresh() {
      page = 0;
      vm.list = [];
      getData(vm.parent_id);
      mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
    }

    function pullupRefresh() {
      setTimeout(function () {
        getData(vm.parent_id);
      }, 800);
    }

    function getData(parent_id) {
      mui.ajax(apiUrl.data_list_page, {
        data: {
          user_name: vm.user_name,
          token: vm.token,
          parent_id: vm.parent_id,
          page_num: ++page,
          num_per_page: 15
        },
        dataType: 'json',
        type: 'post',
        timeout: 10000,
        success: function (data) {
          if (data.status === 0) {
            if (data.pageCount === 1) {
              mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
              mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
            } else if (page === data.endPageIndex) {
              mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
            } else {
              mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
            }
            if (data.recordList.length === 0 && data.currentPage === 1) {
              mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
              mui.confirm('暂无数据!', 'SouthCloud', comArray, function (e) {
                mui.openWindow({
                  url: 'datalist.html',
                  id: './app/datamanager/datalist.html'
                });
                var ws = plus.webview.getWebviewById('data.html');
                ws.close('none');
              }, 'div');
            }
            vm.list = vm.list.concat(data.recordList);
          } else if (data.status === 40004) {
            /* mui.openWindow({
              url: '../../login.html',
              id: 'login',
            }); */
          } else {
            plus.nativeUI.toast(data.info);
          }
        },
        error: function (xhr, type, errorThrown) {
          // 异常处理；
          onNetChange();
        }
      });
    }
  </script>
</body>

</html>