<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello MUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="../../css/mui.min.css">
    <link rel="stylesheet" href="../../css/common.css">
    <script src="../../js/url.js"></script>
    <style type="text/css">
        .font15{
            font-size:16px;
        }
    </style>
</head>

<body>
    <!--下拉刷新容器-->
    <div id="pullrefresh" class="mui-content mui-scroll-wrapper">
        <div class="mui-scroll">
            <!--数据列表-->
            <ul class="mui-table-view mui-table-view-chevron">
            </ul>
        </div>
    </div>
    <script src="../../js/mui.min.js"></script>
    <script>
    mui.init({
        pullRefresh: {
            container: '#pullrefresh',
            up: {
                contentrefresh: '正在加载...',
                callback: pullupRefresh
            }
        },
        gestureConfig: {
            longtap: true, //默认为false
        }
    });

    /**
     * 上拉加载具体业务实现
     */
    var page = 0;
    var page_number;
    var user_name;
    var token;
    var comArray = ['确认'];

    mui.plusReady(function() {
        user_name = plus.storage.getItem("user_name");
        token = plus.storage.getItem("token");
        task_id = plus.storage.getItem("task_id");
        getData();
    });

    function pullupRefresh() {
        setTimeout(function() {
            getData();
        }, 800);
    }

    function getData() {
        mui.ajax(apiUrl.page_task_log, {
            data: {
                user_name: user_name,
                token: token,
                task_id: task_id,
                page_num: ++page,
            },
            dataType: 'json',
            type: 'post',
            timeout: 10000,
            success: function(data) {
                if (data.status == 0) {
                    if (data.pageCount == 1) {
                        // mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                    } else if (page == data.endPageIndex) {
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                    } else {
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
                    }

                    if (data.recordList.length == 0 && data.currentPage == 1) {
                        mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
                        mui.confirm('暂无数据!', 'SouthCloud', comArray, function(e) {
                            mui.openWindow({
                                url: 'tasklist.html',
                                id: 'tasklist.html',
                            });
                            var ws = plus.webview.getWebviewById('tasklog');
                            plus.webview.close(ws);
                        }, 'div');
                    }
                    var table = document.body.querySelector('.mui-table-view');
                    var cells = document.body.querySelectorAll('.mui-table-view-cell');
                    for (var i = 0; i < data.recordList.length; i++) {
                        var time = timeTrans(data.recordList[i].time * 1000, 'yyyy-MM-dd HH:mm:ss');
                        var event;
                        var recordList = data.recordList[i];
                        var JSONObj =  eval('(' + recordList.data + ')');
                        var eventType = recordList.eventType;
                        if(eventType  == 0) {
                            event = '内容：' + recordList.data.remark;
                        } else if (eventType == 1) {
                            if(recordList.data.workStatus == 0) {
                                event = '状态：<span style="color:red">停止工作：</span>' + JSONObj.remark;
                            } else {
                                event = '状态：<span style="color:green">开始工作：</span>' + JSONObj.remark;
                            }
                        } else if(eventType  == 2) {
                            event = '<span class="">提交文件：<span style="color:#06AAE5;">'+  JSONObj.achieveFileName + '</span></span';
                        } else if(eventType  == 3) {
                            event = '点库个数：'+ JSONObj.pointSum +'&nbsp;&nbsp;&nbsp;&nbsp;<br />坐标系统：' + JSONObj.coorSys + '<br />备注：' + JSONObj.remark;
                        } else if(eventType  == 4) {
                            if(JSONObj.processStatus == 100) {
                                event = '工作进度：<span style="color:green">已完成</span>';
                            } else if(JSONObj.processStatus == 0 ) {
                                event = '工作进度：任务启动';
                            } else {
                                event = '工作进度：' + JSONObj.processStatus + '%';
                            }
                        }

                        var li = document.createElement('li');
                        li.className = 'mui-table-view-cell';
                        li.innerHTML = '<div class="mui-row font15"><div class="mui-col-sm-4 mui-col-xs-12 pt5">时间：'+ time + '</div><div class="mui-col-sm-8 mui-col-xs-12 pt5">' + event + '</div></div>';
                        table.appendChild(li);
                    }
                } else if (data.status == 40004) {
                    mui.openWindow({
                        url: '../../login.html',
                        id: 'login',
                    });
                } else {
                    plus.nativeUI.toast(data.info);
                }
            },
            error: function(xhr, type, errorThrown) {
                onNetChange();
            }
        });

    }

    </script>
</body>

</html>
