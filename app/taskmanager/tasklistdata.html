<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello MUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../../css/mui.min.css">
    <link rel="stylesheet" href="../../css/common.css">
    <script src="../../js/url.js"></script>
    <style type="text/css">
        .mui-table-view-chevron .mui-table-view-cell {
            padding-right: 5px;
        }
    </style>
</head>

<body>
    <!--下拉刷新容器-->
    <div id="pullrefresh" class="mui-content mui-scroll-wrapper">
        <div class="mui-scroll">
            <!--数据列表-->
            <ul class="mui-table-view mui-table-view-chevron">
            </ul>
        </div>
    </div>
    <script src="../../js/mui.min.js"></script>
    <script>
    mui.init({
        pullRefresh: {
            container: '#pullrefresh',
            up: {
                contentrefresh: '正在加载...',
                callback: pullupRefresh
            }
        },
        gestureConfig: {
            longtap: true, //默认为false
        }
    });

    /**
     * 上拉加载具体业务实现
     */
    var page = 0;
    var page_number;
    var user_name;
    var token;
    var comArray = ['确认'];

    mui.plusReady(function() {
        user_name = plus.storage.getItem("user_name");
        token = plus.storage.getItem("token");
        getData();
    });

    function pullupRefresh() {
        setTimeout(function() {
            getData();
        }, 800);
    }

    function getData() {
        mui.ajax(apiUrl.apiTaskListPage2, {
            data: {
                'filter_task_status': -9,
                'user_name': user_name,
                'token': token,
                'page_num': ++page,
                'num_per_page': 15,
            },
            dataType: 'json',
            type: 'post',
            timeout: 10000,
            success: function(data) {
                if (data.status == 0) {
                    if (data.pageCount == 1) {
                        mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
                    } else if (page == data.endPageIndex) {
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                    } else {
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
                    }

                    if (data.recordList.length == 0 && data.currentPage == 1) {
                        mui.confirm('暂无数据!', 'South', comArray, function(e) {
                            mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
                            mui.openWindow({
                                url: 'taskmanager.html',
                                id: './app/taskmanager/taskmanager.html',
                            });
                            var ws = plus.webview.getWebviewById('tasklist.html');
                            plus.webview.close(ws);
                        }, 'div');
                    }
                    var recordList = data.recordList;
                    var table = document.body.querySelector('.mui-table-view');
                    var cells = document.body.querySelectorAll('.mui-table-view-cell');
                    for (var i = 0; i < recordList.length; i++) {
                        var createTime = timeTrans(recordList[i].createTime * 1000, 'yyyy-MM-dd HH:mm:ss');
                        var div = document.createElement('div');
                        div.className = 'mui-table-view-cell';
                        div.innerHTML =
                            '<div class="mui-row mui-slider-handle">' +
                            '<div class="mui-col-sm-12 mui-col-xs-12 liTitle" style="padding-right:35px">' +
                            '任务：' + recordList[i].taskName +
                            '</div>' +
                            '<div class="mui-row liContent" style="margin-top:28px">' +
                            '<div class="mui-col-sm-6 mui-col-xs-6" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' +
                            '创建者：' + recordList[i].creatorUserNickName +
                            '</div>' +
                            '<div class="mui-col-sm-6 mui-col-xs-6" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' +
                            '创建时间：' + createTime +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="mui-slider-right mui-disabled" task_id="' + recordList[i].id + '"name="' + recordList[i].taskName + '"><button class="mui-btn mui-btn-primary look">查看</button><button class="mui-btn mui-btn-success log">日志</button><button class="mui-btn mui-btn-red del">删除</button></div>';

                        // '任务名称：' + recordList[i].taskName + '<br /><span class="liContent">创建者：' + recordList[i].creatorUserName + //'<span class="liContent" style="margin-left:35px">操作者：' + recordList[i].workerUserName +
                        // '<br /><span class="liContent">创建时间：' + createTime + '</span></div>';
                        table.appendChild(div);
                    }
                } else if (data.status == 40004) {
                    plus.storage.clear();
                    mui.openWindow({
                        url: '../../login.html',
                        id: 'login',
                    });
                } else {
                    plus.nativeUI.toast(data.info);
                }
            },
            error: function(xhr, type, errorThrown) {
                onNetChange();
            }
        });

    }

    var parentDom,li,task_id,task_name;
    mui('.mui-table-view').on('tap', '.look', function(e) {
        htmlObj(this);
        mui.openWindow({
            url: 'taskdetail.html',
            id: 'taskdetail',
            extras: {
                task_id: task_id,
                task_name: task_name
            }
        });
    });

    mui('.mui-table-view').on('tap', '.log', function(e) {
        htmlObj(this);
        mui.openWindow({
            url: 'tasklog.html',
            id: 'tasklog',
            extras: {
                task_id: task_id,
                task_name: task_name
            }
        });
    });

    mui('.mui-table-view').on('tap', '.del', function(e) {
        htmlObj(this);
        var user_name = plus.storage.getItem("user_name");
        var token = plus.storage.getItem("token");
        var btnArray1 = ['否', '是'];
        mui.confirm('删除选中文件？ ', 'South', btnArray1, function(e) {
            if (e.index == 1) {
                mui.ajax(apiUrl.delete_task, {
                    data: {
                        task_id: task_id,
                        user_name: user_name,
                        token: token
                    },
                    dataType: 'json',
                    type: 'post',
                    timeout: 10000,
                    success: function(data) {
                        if (data.status === 0) {
                            plus.nativeUI.toast('删除成功！');
                            li.parentNode.removeChild(li);
                        } else {
                            plus.nativeUI.toast(data.info);
                        }
                    },
                });
            }
        }, 'div');
    });

    function htmlObj(that) {
        parentDom = that.parentNode;
        li = parentDom.parentNode;
        mui.swipeoutClose(li);
        task_id = parentDom.getAttribute('task_id');
        task_name = parentDom.getAttribute('name');
    }

    window.addEventListener('reload', function(event) {
        location.reload();
    });

    mui('.mui-table-view').on('longtap', '.mui-table-view-cell', function(e) {
        mui.swipeoutOpen(this);
    });
    </script>
</body>

</html>
