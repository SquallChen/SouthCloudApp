<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello MUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../../css/mui.min.css">
    <link rel="stylesheet" href="../../css/common.css">
    <script src="../../js/url.js"></script>
    <style type="text/css">
        .fcontent {
            font-size: 14px;
            color: #000;
        }
    </style>
</head>

<body>
    <!--下拉刷新容器-->
    <div id="pullrefresh" class="mui-content mui-scroll-wrapper">
        <div class="mui-scroll">
            <!--数据列表-->
            <ul class="mui-table-view mui-table-view-chevron">
            </ul>
        </div>
    </div>
    <script src="../../js/mui.min.js"></script>
    <script src="../../js/timetrans.js"></script>
    <script>
    mui.init({
        pullRefresh: {
            container: '#pullrefresh',
            up: {
                contentrefresh: '正在加载...',
                callback: pullupRefresh
            }
        },
        gestureConfig: {
            longtap: true, //默认为false
        }
    });

    /**
     * 上拉加载具体业务实现
     */
    var page = 0;
    var page_number;
    var user_name;
    var token;

    mui.plusReady(function() {
        user_name = plus.storage.getItem("user_name");
        token = plus.storage.getItem("token");
        getData();
    });

    function pullupRefresh() {
        setTimeout(function() {
            getData();
        }, 800);
    }

    function getData() {
        mui.ajax(apiUrl.apiAchieveFileListPage2, {
            data: {
                'user_name': user_name,
                'token': token,
                'page_num': ++page,
                'num_per_page': 15,
            },
            dataType: 'json',
            type: 'post',
            timeout: 10000,
            success: function(data) {
                if (data.status == 0) {
                    if (data.pageCount == 1) {
                        mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
                    } else if (page == data.endPageIndex) {
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                    } else {
                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
                    }

                    if (data.recordList.length == 0 && data.currentPage == 1) {
                        console.log(123);
                        mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
                        mui.confirm('暂无数据!', 'South', ['确认'], function(e) {
                            mui.openWindow({
                                url: 'taskmanager.html',
                                id: './app/taskmanager/taskmanager.html',
                            });
                            var ws = plus.webview.getWebviewById('achievelist.html');
                            plus.webview.close(ws);
                        }, 'div');
                    }

                    var recordList = data.recordList;
                    var table = document.body.querySelector('.mui-table-view');
                    var cells = document.body.querySelectorAll('.mui-table-view-cell');
                    for (var i = 0; i < recordList.length; i++) {
                        var fileSize = byteTrans(recordList[i].fileSize);
                        var createTime = timeTrans(recordList[i].createTime * 1000, 'yyyy-MM-dd HH:mm:ss');
                        var div = document.createElement('div');
                        div.className = 'mui-table-view-cell';
                        div.innerHTML =
                            '<div class="mui-slider-handle">' +
                            '<div class="mui-row liTitle">' +
                            recordList[i].fileName +
                            '</div>' +
                            '<div class="mui-row fcontent">' +
                            '<div class="mui-col-sm-3 mui-col-xs-5 pt4">' +
                            '文件大小：' + fileSize +
                            '</div>' +
                            '<div class="mui-col-sm-3 mui-col-xs-7 pt4">' +
                            // '作业人员：' + recordList[i].workerUserName +
                            '作业人员：' + recordList[i].workerUserNickName +
                            '</div>' +
                            '<div class="mui-col-sm-6 mui-col-xs-12 pt4">' +
                            '创建时间：' + createTime +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="mui-slider-right mui-disabled" achieve_file_id="' + recordList[i].id + '"name="' + recordList[i].fileName + '"><button class="mui-btn mui-btn-primary look">查看</button><button class="mui-btn mui-btn-red del">删除</button></div>';
                        table.appendChild(div);
                    }
                } else if (data.status == 40004) {
                    mui.openWindow({
                        url: '../../login.html',
                        id: 'login',
                    });
                } else {
                    plus.nativeUI.toast(data.info);
                }
            },
            error: function(xhr, type, errorThrown) {
                onNetChange();
            }
        });

    }

    var parentDom, li, achieve_file_id;
    mui('.mui-table-view').on('tap', '.look', function(e) {
        htmlObj(this);
        var fileName = parentDom.getAttribute('name');
        mui.openWindow({
            url: 'achievecontent.html',
            id: 'achievecontent',
            extras: {
                achieve_file_id: achieve_file_id,
                fileName: fileName
            }
        });
    });

    mui('.mui-table-view').on('tap', '.del', function(e) {
        var user_name = plus.storage.getItem("user_name");
        var token = plus.storage.getItem("token");
        var btnArray1 = ['否', '是'];
        mui.confirm('删除选中文件？ ', 'SouthCloud', btnArray1, function(e) {
            if (e.index == 1) {
                mui.ajax(apiUrl.delete_achieve_file, {
                    data: {
                        achieve_file_id: achieve_file_id,
                        user_name: user_name,
                        token: token
                    },
                    dataType: 'json',
                    type: 'post',
                    timeout: 10000,
                    success: function(data) {
                        if (data.status === 0) {
                            plus.nativeUI.toast('删除成功！');
                            li.parentNode.removeChild(li);
                        } else {
                            plus.nativeUI.toast(data.info);
                        }
                    },
                });
            }
        }, 'div');
    });

    function htmlObj(that) {
        parentDom = that.parentNode;
        li = parentDom.parentNode;
        mui.swipeoutClose(li);
        achieve_file_id = parentDom.getAttribute('achieve_file_id');
    }

    mui('.mui-table-view').on('longtap', '.mui-table-view-cell', function(e) {
        mui.swipeoutOpen(this);
    });
    </script>
</body>

</html>
