<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>地图监控</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <meta content="yes" name="apple-mobile-web-app-capable" />
  <meta content="black" name="apple-mobile-web-app-status-bar-style" />
  <meta content="telephone=no" name="format-detection" />
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/custom.css">
  <link rel="stylesheet" href="../../js/v4.2.0-dist/ol.css" type="text/css">
  <link rel="stylesheet" href="../../js/overlay/popupoverlay.css" type="text/css">
  <script src="../../js/jquery-3.1.1.min.js"></script>
  <script src="../../js/v4.2.0-dist/ol.js"></script>
  <script src="../../js/mui.min.js"></script>
  <script src="../../js/url.js"></script>
  <script src="../../js/overlay/popupoverlay.js"></script>
  <style type="text/css">
    html,
    body {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
      -webkit-touch-callout: none;
    }

    #map {
      width: 100%;
      position: fixed;
      top: 96px;
      bottom: 0px;
      background: #fff;
      text-align: center;
    }

    .mui-bar-nav {
      padding-left: 0;
      padding-right: 0
    }

    .header {
      margin-top: 48px;
      height: 48px;
      line-height: 48px;
      border-bottom: 1px solid #dbdbdb;
      background-color: #fff;
    }

    .header .left {
      display: inline-block;
      width: 155px;
      text-align: left;
      font-size: 18px;
      color: #333;
    }

    .right {
      height: 48px;
      line-height: 48px;
      display: inline-block;
      width: calc(100% - 160px);
      padding: 0 10px;
    }

    .header .right input {
      width: 100%;
    }

    .mui-input-row {
      position: relative;
      overflow: visible;
    }

    .mui-input-row .mui-input-clear~.mui-icon-clear {
      top: 15px;
      left: calc(100% - 50px);
      width: 40px;
      height: 40px;
      color: #b3b3b3;
    }

    .header .right span {
      position: absolute;
      width: 40px;
      height: 40px;
      top: 3px;
      left: 15px;
      color: #b3b3b3;
    }

    input[type=text] {
      padding-left: 30px;
    }

    .mui-switch {
      top: 8px;
    }

    .mui-switch.mui-active:before,
    .mui-switch:before {
      top: -10px;
    }

    .list {
      position: fixed;
      display: none;
      top: 92px;
      left: 10px;
      height: 200px;
      width: calc(100% - 180px);
      z-index: 10;
      border: 1px solid #dcdcdc;
      background-color: #fff;
    }

    .mui-table-view {
      height: 40px;
      line-height: 40px;
      padding-left: 10px;
      font-size: 18px;
    }

    .mui-bar .mui-input-row .mui-input-clear~.mui-icon-clear {
      top: 5px;
    }

    img {
      border: 0;
    }

    .mui-popover {
      display: none;
      position: fixed;
      width: 70%;
      height: auto;
      border-radius: 0;
      left: 50%;
      top: 50%;
      margin: 0 auto;
      z-index: 9999;
      background-color: #fff;
      -webkit-transform: translateX(-50%) translateY(-50%);
      -moz-transform: translateX(-50%) translateY(-50%);
      -ms-transform: translateX(-50%) translateY(-50%);
      transform: translateX(-50%) translateY(-50%);
    }

    .mui-popover .mui-table-view {
      background: #fff;
      border-radius: 0px;
      border-bottom: 1px solid #dbdbdb;
    }

    .mui-popover-arrow {
      display: none;
    }

    .popup-info {
      padding: 6px 6px 0 6px;
      text-align: left;
    }

    .popup-info p {
      color: #fff;
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="margin-left: 0"></a>
    <h1 class="mui-title">地图监控</h1>
    <div class="header">
      <div class="right mui-input-row">
        <input type="text" class="mui-input-clear mui-input" placeholder="请输入机器码" id="inputVal">
        <span class="mui-icon mui-icon-search" style="font-size:25px"></span>
      </div>
      <div class="left">
        <span>显示离线</span>
        <div class="mui-switch mui-switch-green mui-active" id="lineStatus" style="display: inline-block;">
          <div class="mui-switch-handle" style="display: inline-block;"></div>
        </div>
      </div>
    </div>
  </header>
  <div class="list" id="list"></div>
  <div id="map" class="map"></div>
</body>

<script type="text/javascript">
  var user_name = '';
  var token = '';
  var monitorUrlAddress = '';
  var map_id_prefix = '';

  mui.plusReady(function () {
    /* 初始化mui控件 */
    mui.init({
      beforeback: function () { }
    });

    plus.webview.currentWebview().setStyle({
      softinputMode: 'adjustResize' // 弹出软键盘时自动改变webview的高度
    });

    user_name = plus.storage.getItem('user_name');
    token = plus.storage.getItem('token');

    mui.ajax(apiUrl.map_url, {
      data: {
        user_name: user_name,
        token: token
      },
      dataType: 'json',
      type: 'post',
      timeout: 10000,
      success: function (data) {
      	console.log('data+'+JSON.stringify(data))
        if (data.status === 0) {
          monitorUrlAddress = data.map_monitor;
          map_id_prefix = data.map_id_prefix;
          showMap();
        } else {
          mui.toast(data.info);
        }
      },
      error: function (xhr, type, errorThrown) {
        onNetChange();
      }
    });

    document.getElementById('inputVal').addEventListener('blur', function (e) {
      document.getElementById('list').style.display = 'none';
    });

    function showMap() {
      // 天地图
      var tianDiTuMapLayer = new ol.layer.Tile({
        title: '天地图路网',
        preload: Infinity,
        source: new ol.source.XYZ({
          url: 'http://t4.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}'
        })
      });
      var tianDiTuAnnotation = new ol.layer.Tile({
        title: '天地图文字标注',
        source: new ol.source.XYZ({
          url: 'http://t3.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}'
        })
      });
      var tianDiTuSatellite = new ol.layer.Tile({
        title: '天地图卫星影像',
        source: new ol.source.XYZ({
          url: 'http://t3.tianditu.com/DataServer?T=img_w&x={x}&y={y}&l={z}'/**/
        })
      });

      var device_vector_layer = new ol.layer.Vector({
        source: new ol.source.Vector({
          format: new ol.format.GeoJSON(),
          // VIEWPARAMS: 'userId:' + userId,
          url: monitorUrlAddress
        }),
        style: function (feature, resolution) {
          var featureProperties = feature.getProperties();
          if (featureProperties === null || featureProperties === undefined) return pointOfflineStyle;
          return featureProperties.online_status === 1 ? pointOnlineStyle : pointOfflineStyle;
        }
      });

      var device_vector_layer_online = new ol.layer.Vector({
        source: new ol.source.Vector({
          format: new ol.format.GeoJSON(),
          url: monitorUrlAddress
        }),
        style: function (feature, resolution) {
          var featureProperties = feature.getProperties();
          if (featureProperties === null || featureProperties === undefined) return;
          if (featureProperties.online_status === 1) {
            return pointOnlineStyle;
          }
        }
      });

      document.getElementById('lineStatus').addEventListener('toggle', function (event) {
        popup.hide();
        if (event.detail.isActive) {
          showOfflineDeivce = true;
          device_vector_layer.setVisible(true);
          device_vector_layer_online.setVisible(false);
        } else {
          device_vector_layer.setVisible(false);
          device_vector_layer_online.setVisible(true);
        }
        /* 切换地图显示数据源  */

        /* device_vector_layer.getSource().updateParams({
          format: new ol.format.GeoJSON(),
          url: monitorUrlAddress + '&viewparams=onlineStatus:' + '123',
          t: new Date().getMilliseconds()
        }); */
      });

      var timer;
      document.getElementById('inputVal').addEventListener('keyup', function (e) {
        setTimeout(function () {
          var val = document.getElementById('inputVal').value;
          timer = mui.ajax(apiUrl.device_list, {
            data: {
              user_name: user_name,
              token: token,
              filter_identifycode: val,
              page_num: 1,
              num_per_page: 5
            },
            dataType: 'json',
            type: 'post',
            timeout: 10000,
            success: function (data) {
              if (data.status === 0) {
                if (data.recordList.length !== 0) {
                  rtkArr = data.recordList;
                  var str = '';
                  for (var i = 0; i < data.recordList.length; i++) {
                    str += '<div class="mui-table-view" id="' + data.recordList[i].id + '">' + data.recordList[i].identifyCode + '</div>';
                  }
                  document.getElementById('list').innerHTML = str;
                  document.getElementById('list').style.display = 'block';
                } else {
                  document.getElementById('list').style.display = 'none';
                  mui.toast('暂无搜索结果！');
                }
              } else {
                mui.toast(data.info);
              }
            },
            error: function (xhr, type, errorThrown) {
              // 异常处理；
              onNetChange();
            }
          });
        }, 500);
      });

      mui('.list').on('tap', '.mui-table-view', function (e) {
        document.getElementById('list').style.display = 'none';
        document.getElementById('inputVal').blur();
        timer.abort();
        var deviceId = this.getAttribute('id');
        var selectFeature = device_vector_layer.getSource().getFeatureById(map_id_prefix + '.' + deviceId);
        if (selectFeature === undefined || selectFeature === null) {
          mui.toast('地图上暂无查询到此设备!');
          return;
        }

        popup.hide();
        var currentZoom = olMap.getView().getZoom();
        mapCenter(selectFeature.getGeometry().getCoordinates(), currentZoom > 14 ? currentZoom : 14);
        setTimeout(function () {
          displayDeviceInfoOverlay(selectFeature);
        }, 2000);
      });

      /**
       * 调用外部的JS创建弹出框
       * Create xiaoJing 2017年11月7日23:57:49
       */
      var popup = new ol.Overlay.Popup({
        popupClass: 'black', // "tooltips", "warning" "black" "default", "tips", "shadow",
        closeBox: true,
        positioning: 'auto',
        autoPan: true,
        autoPanAnimation: { duration: 250 }
      });

      // 比例尺控件
      var scaleLineControl = new ol.control.ScaleLine();

      var olMap = new ol.Map({
        layers: [
          tianDiTuMapLayer, tianDiTuAnnotation, device_vector_layer, device_vector_layer_online
          // tianDiTuOfflineGuangzhowRoadmap, tianDiTuOfflineGuangzhowOverlay_r
        ],
        overlays: [popup],
        target: 'map',
        controls: ol.control.defaults({
          attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
            collapsible: false
          }),
          attribution: false
        }).extend([
          scaleLineControl
        ]),
        view: new ol.View({
          // 指定投影使用EPSG:4326
          projection: 'EPSG:4326',
          constrainRotation: false,
          enableRotation: false,
          center: [113.2652664185, 23.1349929688],
          zoom: 8,
          minZoom: 4,
          maxZoom: 24
        })
      });

      // 地图中心调用函数
      function mapCenter(position, zoom) {
        olMap.getView().animate({
          center: position,
          duration: 1500,
          zoom: zoom
        });
      }

      var pointOnlineStyle = new ol.style.Style({
        image: new ol.style.Icon({
          src: '../../public/img/device_online.png',
          anchor: [0.5, 0.5] // 设置图标位置
        })
      });
      var pointOfflineStyle = new ol.style.Style({
        image: new ol.style.Icon({
          src: '../../public/img/device_offline.png',
          anchor: [0.5, 0.5] // 设置图标位置
        })
      });

      olMap.on('singleclick', function (evt) {
        if (evt.dragging) {
          return;
        }
        var pixel = olMap.getEventPixel(evt.originalEvent);
        var feature = olMap.forEachFeatureAtPixel(pixel, function (feature, layer) {
          return feature;
        });
        if (feature === null || feature === undefined) return;
        displayDeviceInfoOverlay(feature);
      }, device_vector_layer);

      /**
       * 显示指定轨迹点的提示框信息, 显示 结算状态, 时间, 经纬度等信息
       * @param selectFeature MAP中的地物
       * Create xiaoJing 2017年11月8日00:02:13
       */
      function displayDeviceInfoOverlay(selectFeature) {
        popup.hide();
        if (selectFeature === undefined) return;
        var deviceItemInfo = selectFeature.getProperties();
        if (deviceItemInfo === undefined) return;
        var content = '<div class="popup-info">';
        content += '<p>设备编号:' + deviceItemInfo.identify_code + '</p>';
        if (deviceItemInfo.online_status === 1) {
          content += '<p>连接时间:' + timeTrans(deviceItemInfo.connect_time, 'yyyy-MM-dd HH:mm:ss') + '</p>';
        } else {
          content += '<p>断开时间:' + timeTrans(deviceItemInfo.disconnect_time, 'yyyy-MM-dd HH:mm:ss') + '</p>';
        }
        var upDataUserName = deviceItemInfo.up_data_user_name ? deviceItemInfo.up_data_user_name : '-';
        var upDataCompanyInfo = deviceItemInfo.up_data_company_info ? deviceItemInfo.up_data_company_info : '-';
        content += '<p>经度:' + formatDegree(deviceItemInfo.longitude) + '</p>';
        content += '<p>纬度:' + formatDegree(deviceItemInfo.latitude) + '</p>';
        content += '<p>用户名:' + upDataUserName + '</p>';
        content += '<p>用户单位:' + upDataCompanyInfo + '</p></div>';

        popup.show(selectFeature.getGeometry().getCoordinates(), content);
      }
    }
  });
</script>

</html>