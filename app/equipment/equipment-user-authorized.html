<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/custom.css">
		<link rel="stylesheet" href="../../css/iconfont.css">
		<style>
			* {
				padding: 0;
				margin: 0;
				box-sizing: border-box;
			}
			
			html,
			body,
			#vm {
				height: 100%;
			}
			
			a {
				color: #333;
			}
			
			.filter {
				width: 100%;
				usertitle
			}
			
			.filter a {
				display: block;
				width: 80%;
				height: 50px;
				line-height: 50px;
				font-size: 14px;
				padding-left: 20px;
			}
			
			.btn {
				background: none;
				border: none;
				color: white;
				font-size: 40px;
				line-height: 24px;
				width: 48px;
				height: 48px;
				float: right;
				right: -4px;
			}
			
			.filter {
				height: 51px;
			}
			
			.filter ul li {
				display: flex;
				align-items: center;
				padding-left: 10px;
				padding-right: 10px;
				position: relative;
				flex-wrap: wrap;
				position: relative;
			}
			
			.filter ul li img {
				width: 38px;
				height: 44px;
			}
			
			.filter .userentry {
				border-bottom: 1px solid #ccc;
			}
			
			.filter .border_bottom {
				display: block;
				width: 100%;
				height: 1px;
				background: #ccc;
				left: 30px;
				bottom: 0px;
				-webkit-transform: scaleY(.5);
			}
			
			.mui-bar .mui-icon {
				font-size: 32px;
			}
			
			.mui-bar .mui-title {
				right: 50px;
				left: 50px;
			}
			
			.mui-content {
				background: white;
				display: flex;
				flex-direction: column;
			}
			
			.usertitle {
				width: 100%;
				background: #e8e8e8;
				padding-left: 20px;
				height: 36px;
				line-height: 36px;
				color: #333;
				font-weight: 500;
				font-size: 15px;
			}
			
			.personnelInfo {
				width: 100%;
				overflow: auto;
				flex: 1;
				font-size: 13px;
			}
			
			.personnelInfo ul li {
				height: 40px;
			}
			
			.back {
				display: block;
				width: 10px;
				height: 16px;
				background: url('../../public/img/back.png') no-repeat;
				background-size: 10px 16px;
				margin-left: 10px;
			}
			
			.mui-table-view-cell>.mui-slider-left>.mui-btn:after,
			.mui-table-view-cell>.mui-slider-right>.mui-btn:after {
				position: relative;
			}
			
			.mui-icon-back:before,
			.mui-icon-left-nav:before {
				content: '';
			}
			
			.mui-bar-nav.mui-bar .mui-icon {
				width: 73px;
				height: 52px;
				top: 21px;
				display: flex;
				align-items: center;
			}
			
			.personnelInfo .mui-table-view-cell {
				padding: 0 10px 0 10px;
			}
			
			.personnelInfo .userInfo {
				width: 100%;
				display: flex;
				justify-content: space-between;
			}
			
			.personnelInfo .title {
				font-weight: 500;
				font-size: 14px;
			}
			
			.personnelInfo .userInfo span {
				display: block;
			}
			
			.personnelInfo .userInfo span:nth-child(1),
			.personnelInfo .userInfo span:nth-child(2) {
				flex: 1;
				font-size: 14px;
			}
			
			.personnelInfo .userInfo .status {
				width: 42px;
				text-align: right;
			}
			
			.selectBtn {
				background: transparent;
				border: none;
				color: white;
				float: right;
				position: relative;
				top: 32px;
				left: 8px;
				font-size: 15px;
			}
			
			.noSelect {
				opacity: .4;
			}
			
			.mui-table-view-cell:after {
				left: 0;
				background-color: #ccc;
			}
			
			.mui-popover {
				height: 300px;
			}
			
			.mui-popover {
				width: 180px;
				height: 166px;
				box-shadow: 0 0 15px rgba(0, 0, 0, .3);
				background: white;
			}
			
			.mui-backdrop {
				background: transparent;
			}
			
			.mui-scroll-wrapper,
			.mui-popover .mui-popover-arrow:after,
			.mui-scroll-wrapper .mui-table-view-cell {
				/*background: #49484a;
				color: white;*/
			}
			
			.mui-popover .mui-scroll-wrapper {
				margin: 0;
			}
			
			.mui-popover .mui-table-view .mui-table-view-cell:last-child,
			.mui-popover .mui-table-view .mui-table-view-cell:last-child,
			.mui-popover .mui-table-view .mui-table-view-cell:last-child>a:not(.mui-btn),
			.mui-popover .mui-table-view .mui-table-view-cell:first-child>a:not(.mui-btn) {
				border-bottom-left-radius: 0;
				border-bottom-right-radius: 0;
				border-top-left-radius: 0;
				border-top-right-radius: 0;
			}
			
			.mui-content .mui-icon {
				color: #ccc;
				position: absolute;
				right: 15px;
				top: 13px;
			}
			
			.mui-popover .mui-table-view {
				background: white;
			}
			
			.mui-popover .mui-table-view {
				border-radius: 7px;
			}
			
			.mui-popover .mui-popover-arrow:after {
				background: white;
			}
			
			.mui-popover {
				width: 122px;
				height: 50px;
				box-shadow: 0 0 15px rgba(0, 0, 0, .3);
				background: white;
			}
			
			.mui-popover .mui-table-view .mui-table-view-cell:first-child {
				border-top-left-radius: 12px;
				border-top-right-radius: 12px;
			}
			
			.mui-table-view-cell {
				padding: 11px 20px;
			}
			
			.mui-table-view-cell:after {
				height: 1;
			}
			
			.mui-checkbox.mui-left label {
				display: flex;
				align-items: center;
				padding: 0 0 0 37px;
				height: 40px;
				line-height: 20px;
			}
			
			.mui-checkbox.mui-left input[type=checkbox] {
				left: 15px;
			}
			
			.mui-checkbox input[type=checkbox] {
				top: 5px;
			}
			
			.filter {
				height: 50px;
				width: 100%;
				font-size: #333;
			}
			
			.filter ul:after,
			.filter ul:before {
				width: 100%;
				height: 1px;
				content: '';
				display: block;
				padding: 0;
				position: relative;
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: #ccc;
			}
			
			.filter ul:after {
				top: -1px;
			}
			
			.filter ul li {
				display: flex;
				align-items: center;
				padding-left: 10px;
				padding-right: 10px;
				position: relative;
				flex-wrap: wrap;
				position: relative;
			}
			
			.userEntryImg {
				display: inline-block;
				width: 22px;
				height: 22px;
				background: url(../../public/img/user_icon02.png) no-repeat;
				background-size: 19px 22px;
				margin-left: 5px;
			}
			
			.filter a {
				display: block;
				width: 80%;
				height: 50px;
				line-height: 50px;
				font-size: 14px;
				padding-left: 20px;
				color: #333;
			}
			
			.mui-content .mui-icon {
				color: #ccc;
				position: absolute;
				right: 15px;
				top: 13px;
			}
			.padding_top {
				width: 100%;
				height: 21px;
				background: #e8e8e8;
			}
			.mui-radio.mui-left input[type=radio]{
				left: 5px;
				width: 15px;
				height: 15px;
				top:12px;
				line-height: 12px;
			}
			.mui-radio.mui-left label{
				padding-left: 37px;
				padding-right: 0;
			}
			.mui-input-row label{
				padding: 13px 15px;
			}
			.mui-checkbox input[type=checkbox]:checked:before, .mui-radio input[type=radio]:checked:before{
				color: #0b60de;
			}
			.mui-checkbox input[type=checkbox]:before, .mui-radio input[type=radio]:before{
				font-size: 15px;
			}
			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body>
		<div id="vm">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left">
					<span class="back"></span>
				</a>
				<button class="selectBtn" @click="add">完  成</button>
				<h1 class="mui-title">添加授权用户</h1>
			</header>
			<div class="mui-content">
				<div class="padding_top"></div>
				<div class="filter">
					<ul class="filter-ul">
						<li class="filter-li">
							<span class="userEntryImg"></span>
							<a href="#" data-href="../personnel/userfilter.html" v-on:tap="openpage">用户筛选</a>
							<span class="mui-icon mui-icon-arrowright"></span>
						</li>
					</ul>
				</div>
				<div class="usertitle">
					<span>人员</span>
				</div>
				<div class="personnelInfo">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell content">
							<div class="mui-input-row mui-checkbox mui-left">
								<label>
								<div class="userInfo title">
									<span>用户账号</span><span>用户名称</span>
								</div>
								</label>
							</div>
						</li>
						<li class="mui-table-view-cell content" v-for="item in deviceData">
							<div class="mui-input-row mui-radio mui-left">
								<label>
									<input name="radio" :value="item.id" v-model="checkUserArr" type="radio">
									<div class="userInfo">
										<span>{{item.username}}</span><span>{{item.realname}}</span>
									</div>
								</label>
							</div>
						</li>
					</ul>
				</div>
			</div>

		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/url.js"></script>
		<script src="../../js/vue.min.js"></script>
		<script type="text/javascript">
			var allocationAuthorization_page = null;
			mui.init({
				beforeback: function() {},
			});
			mui.plusReady(function() {});
			var vm = new Vue({
				el: '#vm',
				user_name: '',
				token: '',
				data: {
					token: '',
					user_name: '',
					rtkCount: '',
					onlineRtkCount: '',
					mapRtk: '',
					list_child: '',
					deviceData: '',
					keywords: '',
					workGroup: '',
					deviceData: '',
					isSelected: false,
					checkUserArr: '',
					identifyCode: ''
				},
				methods: {
					openpage: function() {
						var data_url = event.target.dataset.href;
						mui.openWindow({
							url: data_url,
							id: data_url,
							extras: {
								parentPage: 'equipment-user-authorized',
							}
						});
					},
					add: function() {
						if(this.checkUserArr.length === 0) {
							mui.toast('请选择用户!');
							return;
						}
						console.log(vm.user_name)
						console.log(vm.token)
						console.log(vm.checkUserArr)
						console.log(vm.identifyCode)
						mui.ajax(apiUrl.auth_add_user_device, {
							data: {
								user_name: vm.user_name,
								token: vm.token,
								target_user_id: vm.checkUserArr,
								identify_code: vm.identifyCode
							},
							dataType: 'json',
							type: 'post',
							timeout: 10000,
							success: function(data) {
								console.log('分发授权'+JSON.stringify(data))
								if(data.status === 0) {
									if(allocationAuthorization_page == null) {
										allocationAuthorization_page = plus.webview.getWebviewById('../equipment/allocationAuthorization.html');
									}
									mui.fire(allocationAuthorization_page, 'refreshAllocationAuthorization', {
										keywords: vm.keywords,
										workGroup: vm.workGroupValue
									});
									mui.toast('添加授权用户成功！')
									plus.webview.currentWebview().close();

								} else if(data.status === 40004) {
									mui.openWindow({
										url: '../../login.html',
										id: 'login'
									});
								} else {
									plus.nativeUI.toast(data.info);
									setTimeout(function() {
										plus.nativeUI.closeWaiting();
									}, 1000);
								}
							},
							error: function(xhr, type, errorThrown) {
								// 异常处理；
								onNetChange();
								plus.nativeUI.closeWaiting();
							}
						});
					}
				},
				created: function() {
					mui.plusReady(function() {
						mui.init({});
						// 登陆时存放到本地的数据
						vm.token = plus.storage.getItem('token');
						vm.user_name = plus.storage.getItem('user_name');
						// 获取上层页面传递过来的参数
						var self = plus.webview.currentWebview();
						vm.identifyCode = self.identifyCode;
						//请求用户数据
						getUserData();
						window.addEventListener('refreshUser', function() {
							console.log('刷新用户页面数据了...');
							getUserData();
						});
						window.addEventListener('userDataFilter', function(event) {
							console.log('刷新equipment-user-authorized页面数据.....');
							vm.keywords = event.detail.keywords;
							vm.workGroup = event.detail.workGroup;
							getFilterUserData();
						});

						function getUserData() {
							mui.ajax(apiUrl.stuff_lists, {
								data: {
									user_name: plus.storage.getItem('user_name'),
									token: plus.storage.getItem('token'),
									num_per_page: 10000
								},
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data) {
									if(data.status === 0) {
										//console.log(JSON.stringify(data));
//										var tempData = data.recordList;
//										var tempArray = [];
//										// 当设备onlineStatus===1（在线时），在线设备push进临时数组，原数组删除该条元素，最后将临时数组unshift回原数组，达到排列到队列前面的目的
//										for(var i = 0; i < tempData.length; i++) {
//											if(tempData[i].status === 0) {
//												tempArray.push(tempData[i]);
//												tempData.splice(i, 1);
//											}
//										}
//										for(var i = 0; i < tempArray.length; i++) {
//											tempData.unshift(tempArray[i]);
//										}
//										// 完成排列处理的数组数据添加到页面上渲染
										vm.deviceData = data.recordList;
										//console.log(JSON.stringify(vm.deviceData));
									} else if(data.status === 40004) {
										mui.openWindow({
											url: '../../login.html',
											id: 'login'
										});
									} else {
										plus.nativeUI.toast(data.info);
										setTimeout(function() {
											plus.nativeUI.closeWaiting();
										}, 1000);
									}
								},
								error: function(xhr, type, errorThrown) {
									// 异常处理；
									onNetChange();
									plus.nativeUI.closeWaiting();
								}
							});
						};

						function getFilterUserData() {
							mui.ajax(apiUrl.stuff_lists, {
								data: {
									user_name: plus.storage.getItem('user_name'),
									token: plus.storage.getItem('token'),
									num_per_page: 10000,
									filter_sub_name: vm.keywords,
									filter_work_group: vm.workGroup
								},
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data) {
									if(data.status === 0) {
										if(data.totalCount === 0) {
											vm.deviceData = [];
											mui.toast('没有匹配的用户信息！')
										} else {
											var tempData = data.recordList;
											var tempArray = [];
											// 当设备onlineStatus===1（在线时），在线设备push进临时数组，原数组删除该条元素，最后将临时数组unshift回原数组，达到排列到队列前面的目的
											for(var i = 0; i < tempData.length; i++) {
												if(tempData[i].status === 0) {
													tempArray.push(tempData[i]);
													tempData.splice(i, 1);
												}
											}
											for(var i = 0; i < tempArray.length; i++) {
												tempData.unshift(tempArray[i]);
											}
											// 完成排列处理的数组数据添加到页面上渲染
											vm.deviceData = tempData;
										}

									} else if(data.status === 40004) {
										mui.openWindow({
											url: '../../login.html',
											id: 'login'
										});
									} else {
										plus.nativeUI.toast(data.info);
										setTimeout(function() {
											plus.nativeUI.closeWaiting();
										}, 1000);
									}
								},
								error: function(xhr, type, errorThrown) {
									// 异常处理；
									onNetChange();
									plus.nativeUI.closeWaiting();
								}
							});
						}
					});
				}
			});
		</script>
	</body>

</html>